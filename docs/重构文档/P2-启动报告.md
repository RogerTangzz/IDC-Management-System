# P2 启动报告（Ticket 模板层重构）

本报告明确 P2 的目标、范围、实施计划、测试矩阵、覆盖率门禁与回滚策略，用于指导并行推进（在 P1 提升覆盖的同时启动 P2）。
P2 启动报告: IDC-Management-System/IDC-Management-System/docs/重构文档/P2-启动报告.md：目标/范围/里程碑/用例矩阵/门禁与回滚。
进度总览: IDC-Management-System/IDC-Management-System/docs/refactoring-progress.md：当月记录与阈值阶段目标。
覆盖率标准: IDC-Management-System/IDC-Management-System/docs/重构文档/覆盖率标准.md：全局阈值参考。
核心代码（模板相关）

模板视图: IDC-Management-System/IDC-Management-System/frontend/src/views/business/ticket/template.vue（P2 改造主体）。
组件表单: IDC-Management-System/IDC-Management-System/frontend/src/views/business/ticket/components/TicketForm.vue（如模板复用表单需对齐其校验/字段）。
列表对照: IDC-Management-System/IDC-Management-System/frontend/src/views/business/ticket/index.vue（P1 里对齐的模式、去抖/错误兜底思路可复用）。
工具函数参考: IDC-Management-System/IDC-Management-System/frontend/src/views/business/ticket/index.util.ts（ensureSafeRequest、查询合并等模式）。
接口与领域

业务 API: IDC-Management-System/IDC-Management-System/frontend/src/api/business/ticket.ts（add/update/reopen 等契约、响应结构）。
适配/领域/服务:
IDC-Management-System/IDC-Management-System/frontend/src/adapters/TicketAdapter.ts
IDC-Management-System/IDC-Management-System/frontend/src/domain/ticket/TicketDomain.ts
IDC-Management-System/IDC-Management-System/frontend/src/services/ticket.service.ts
后端约定参考: IDC-Management-System/IDC-Management-System/backend-contracts/ticket-export.md（字段与返回体风格）。
特性开关与预设

开关实现: IDC-Management-System/IDC-Management-System/frontend/src/config/FeatureFlags.ts
预设/回退: IDC-Management-System/IDC-Management-System/frontend/src/config/FlagPresets.ts（确认 USE_TICKET_TEMPLATE_V2 在 dev/stage 开启，prod 关闭）。
入口接入: IDC-Management-System/IDC-Management-System/frontend/src/main.js（applyPreset 生效路径）。
测试与门禁

测试基座: IDC-Management-System/IDC-Management-System/frontend/src/__tests__/setup.ts（Element Plus 组件桩、el-form 最小 validate/reset、指令桩）。
P2 测试配置: IDC-Management-System/IDC-Management-System/frontend/vitest.ticket.p2.config.ts（仅跑 ticket.template.*.test）。
覆盖率门禁: IDC-Management-System/IDC-Management-System/frontend/scripts/coverage-check.mjs（template.vue Stage 1 行/句≥60、分支≥45、函数≥30）。
运行脚本:
npm run test:ticket:p2
npm run coverage:check
对照参考（从 P1 复用的思路）

基础/模式/动作/删除/校验失败等用例模式：
frontend/src/__tests__/ticket.list.basic.test.ts
frontend/src/__tests__/ticket.list.modeFromRoute.test.ts
frontend/src/__tests__/ticket.list.actions.more.test.ts
frontend/src/__tests__/ticket.list.sort.delete.cancel.test.ts
frontend/src/__tests__/ticket.list.submit.validateFalse.test.ts
frontend/src/__tests__/ticket.list.route.watch.test.ts
frontend/src/__tests__/ticket.list.autoClick.buttons.test.ts
frontend/src/__tests__/ticket.list.functions.callAll.test.ts
CI 与目录规范

CI 工作流: IDC-Management-System/IDC-Management-System/.github/workflows/ci.yml（ticket_only 任务；按需新增 template-only）。
目录与根路径: IDC-Management-System/IDC-Management-System/docs/REFACTORING.md 与 IDC-Management-System/IDC-Management-System/docs/重构文档/9.15 9.49重构报告对接.txt（双层目录约定、编码/迁移注意事项）。

## 目标（What & Why）
- 统一模板层（`template.vue`）的提交流程：validate false / add / update 的状态机清晰、可测试。
- 增强取消/失败链路：提交前/中/后错误可见、loading 可复位、操作可回退。
- 复用通用工具：与 P1 一致使用 `ensureSafeRequest`、去抖策略、统一消息提示。
- 建立逐步抬升的覆盖率门禁（Stage→Target：85/90/80/85），作为持续质量保障。

## 范围（Scope）
- 文件：`frontend/src/views/business/ticket/template.vue`
- 功能：
  - 表单校验失败（validate false）不触发请求，UI 复位；
  - 新增/更新请求成功与失败的提示与复位；
  - 取消操作的状态收敛（关闭弹窗、清空表单、停止 loading）；
  - 错误兜底（网络/服务端校验/未知异常）的统一处理；
  - 去抖（如重复提交防抖）。
- 非目标：不修改 `index.vue` 列表行为；不变更 API 契约（仅在 Adapter/Service 层模拟失败分支）。

## 实施计划（Milestones）
1) 状态机梳理与接入（Day 1）
   - 明确表单状态：idle/loading/success/fail/canceled
   - 接入 `ensureSafeRequest` 与统一错误提示 `$modal.msgError`
2) 验证与取消链路（Day 2）
   - validate false 提交中断、loading 复位
   - 取消操作关闭弹窗、重置表单
3) 新增/更新分支（Day 3）
   - add/update 成功/失败路径及异常兜底
   - 成功后状态复位、刷新上层列表（若由父组件触发）
4) 覆盖率与门禁（Day 4）
   - 添加用例矩阵（见下）
   - 覆盖率（Stage 1）达标并接入 CI
5) 收尾与文档（Day 5）
   - 补充分支、边界用例；达成阶段性阈值
   - 同步 REFACTORING 记录与回滚说明

## 用例矩阵（Tests）
- `ticket.template.submit.validateFalse.test.ts`
  - 必填缺失 → validate 返回 false → 不发请求、loading 复位
- `ticket.template.submit.add.update.test.ts`
  - add 成功/失败/异常；update 成功/失败/异常；提示与复位正确
- `ticket.template.cancel.test.ts`
  - 点击取消后：关闭、表单清理、无多余请求
- `ticket.template.error.fallback.test.ts`
  - 模拟网络错误/后端校验失败（400/422）；统一错误提示与复位

Mock/Stub 指南：
- Router/Store 全部最小化桩（见 `src/__tests__/setup.ts` 模式）
- API 通过 `vi.mock('@/api/business/ticket', ...)` 注入 add/update 的成功/失败分支
- Element Plus 采用测试桩；表单 `el-form` 提供最小 `validate/reset` 能力

## 覆盖率门禁（Coverage Gates）
- Stage 1（已配置）：`template.vue` 行≥60 / 句≥60 / 分支≥45 / 函数≥30
- Stage 2：行/句≥70 / 分支≥55 / 函数≥40
- Stage 3：行≥80 / 句≥85 / 分支≥65 / 函数≥55
- Target：行≥85 / 句≥90 / 分支≥80 / 函数≥85

门禁实施：
- `frontend/scripts/coverage-check.mjs` 中已按“分文件阈值”接入 `template.vue` 的 Stage 1 条目；
- 新增 `npm run test:ticket:p2` 与 `test:ci:p2` 用于独立跑 P2 用例与门禁。

## 特性开关（Feature Flag）
- 新增 `USE_TICKET_TEMPLATE_V2`：dev/stage 默认开启，prod 默认关闭；
- 回滚方案：`applySafeRollback()` 将该开关设为 false，保持旧模板路径可用。

## 风险与对策（Risks & Mitigations）
- 共享工具变化影响 P1：严格遵循“先增量后替换”，工具更改保持向后兼容。
- 覆盖率波动：采用分文件门禁；未达标不影响其他路径合并。
- UI 差异：模板交互变化由 Flag 隔离；联动上层刷新通过事件/接口回调实现，确保最小侵入。

## 输出交付（Deliverables）
- 代码：`template.vue` 状态机与相关逻辑；
- 测试：上述用例文件与通过 `test:ticket:p2` 的报告；
- 文档：本报告、变更记录（REFACTORING.md）与回滚指引；
- CI：`ticket_template_only` 或与现有 ticket-only 并列的 P2 任务（按需启用）。


---

## Stage 6（观测与旗标治理）落地补充

- 事件埋点：新增 `frontend/src/infra/telemetry.ts`，导出 `track/setTelemetryProvider`，默认 NOOP；支持 ConsoleProvider 便于本地验证。
- 组合式接入：`useTicketTemplate.ts:1` 对 busy/validate_false/success/error/abort/cancel 分支打点，并记录 `durationMs` 与 `type(add|update)`。
- 视图接入：`template.vue:1` 打点 `dialog_open`、校验失败的 `validate_false(firstInvalidField)`、`enter_press`（Enter 提交路径识别）。
- 旗标热切换：监听 `USE_TICKET_TEMPLATE_V2`，在非 prod 环境执行轻量 smoke（打开→校验失败→取消），并记录 `flag_switched`。
- 测试：新增 telemetry smoke 用例与 view 集成用例；独立配置 `frontend/vitest.ticket.telemetry.config.ts`。
- CI：新增 `template_telemetry_smoke` 任务执行 `npm run test:ci:telemetry`，与 P2 门禁并行、互不阻塞。
- 回滚演练：新增 `npm run demo:rollback` 脚本，指导通过 localStorage 切换开关并验证旧路径可用。

验收标准：
- 本地与 CI：`npm run test:ticket:p2`、`npm run coverage:check`、`npm run test:ci:p2`、`npm run test:ci:telemetry` 全绿；
- dev/stage：热切换无白屏/无异常日志；轻量 smoke 可执行；ConsoleProvider 可见关键事件；
- 回滚演练：脚本指引完成操作，旧路径验证通过。

---

## Stage 7（灰度放量）方案

分段放量（按租户/角色/组织）：
- 评估维度：`tenantId/orgId/roles/userId`（user store 可提供 roles 与 id）
- 新增评估器：`frontend/src/config/FlagEvaluator.ts`，结合 `FeatureFlags` 与 `ROLLOUTS`（`frontend/src/config/FlagRollouts.ts`）计算是否命中放量；
- 规则支持：`percent`（0–100 分桶）、`allowRoles`、`allowTenants`、`allowOrgs`；
- 默认策略：dev/stage 100% 开启；prod 保持 0%，待 GA 再切换。

接入建议：
- 业务入口处（如路由守卫/父级容器）调用 `isFlagOn('USE_TICKET_TEMPLATE_V2', env, userCtx)` 决定走 V2 或回退路径；已在 `src/store/modules/user.ts:getInfo()` 落地：拿到用户信息后计算生效值并通过 `FeatureFlags.setFlag` 应用（触发热切换监听与 smoke）。
- 变更时机：stage 环境先设置 `ROLLOUTS.stage.USE_TICKET_TEMPLATE_V2.percent = 10/25/50/100` 逐步提升；必要时结合 `allowRoles` 做白名单；
- 监控联动：观测板监控错误率/成功率/耗时/取消率/重入率，超过阈值执行回滚。

监控侧对接：
- Provider 注入：`src/main.js` 在 dev/stage 默认注入 `ConsoleTelemetry`，也可通过 `VITE_TELEMETRY_CONSOLE=1` 强制启用；
- 平台对接：可基于 `src/infra/telemetry.providers.ts` 使用 `createSentryProvider` 接入 Sentry（或自有埋点 SDK），在 main.js 中 `setTelemetryProvider(...)` 注入；
- 事件规范：所有事件携带 `scene: ticket_template`、`version: v2`、`ts: ISO`，便于过滤与聚合。

验收标准：
- stage 环境分阶段放量 3–5 天：
  - 指标：错误率≤1%，提交成功率≥98.5%，平均耗时≤1500ms，P95≤3000ms；
  - 超阈值自动告警，必要时回滚；
- 回滚通道可用（人工/自动皆可），演练记录完整。

---

## Stage 8（GA 与收尾）

目标：将模板 V2 在生产环境设为默认，保留 1–2 周软回滚期；清理冗余路径/文案与测试收敛；完成文档与移交。

已执行变更：
- 开关默认：`frontend/src/config/FlagPresets.ts` 将 `prod.USE_TICKET_TEMPLATE_V2` 置为 `true`；仍保留 `SAFE_ROLLBACK` 可一键回退；
- 监控与回滚：沿用 Stage 6 Telemetry 与 Stage 7 rollout/flag 应用机制；生产回滚可通过平台告警触发或人工执行；

建议与清理：
- 死代码/冗余路径清理：对旧模板路径与已废弃的分支进行标注与删除（保留回滚期后执行）；
- 文案统一：成功/失败提示与错误兜底在 util 层统一（如“提交失败/返回结果异常”）；
- 用例收敛：保留高价值路径（新增/更新/取消/错误兜底/可达性/并发防抖/埋点 smoke），去除临时/重复覆盖用例；

验收标准：
- `prod` 环境默认开启 V2，软回滚期内指标稳定（错误率≤1%、成功率≥98.5%、平均≤1500ms、P95≤3000ms）；
- 回滚演练在生产影子环境或低风险时段完成；
- 代码清理已合并，文档和移交完成。
