import{_ as Be,a1 as Fe,s as R,a2 as He,a3 as Me}from"./index-Cw83YE5u.js";import{k as Ae,g as Ee,ar as Oe,ap as Ye,r as _,d as ne,c as je,ac as c,ag as se,l as y,m as d,D as N,J as a,B as p,C as t,E as f,q as m,H as r,u as x,G as o,I as U,$ as P}from"./vue-SR65qDCS.js";import"./element-D8D5Bqo2.js";import"./vendor-C71Ev03J.js";const Ge={class:"app-container"},Je={class:"card-header"},We={class:"title"},Ke={class:"header-buttons"},Qe={class:"text-primary"},Xe={key:1},Ze={class:"description-content"},et={class:"description-content"},tt={class:"description-content"},at={class:"attachment-list"},lt={class:"log-filters"},nt={class:"log-content"},st={class:"log-user"},ot={class:"log-action"},it={key:0},ut={key:0,class:"log-remark"},rt={key:0,class:"log-pagination"},dt={class:"action-buttons"},ct={class:"dialog-footer"},mt={class:"dialog-footer"},pt=Ae({name:"TicketDetail"}),_t=Object.assign(pt,{setup(ft){const{proxy:v}=Ee(),q=Oe(),Y=Ye(),w=Y.params.ticketId||Y.params.id,B=_(!1),$=_(!1),D=_(!1),F=_([]),j=_([]),g=_({pageNum:1,pageSize:10,total:0}),k=_({action:"",daterange:[]}),G=_([]),J=_([]),{ticket_status:oe,ticket_priority:ie,equipment_specialty:ue,ticket_action:H}=v.useDict("ticket_status","ticket_priority","equipment_specialty","ticket_action");ne(()=>{G.value=(H||[]).map(s=>({value:s.value,label:s.label}))});const l=_({}),W=_(""),V=_({assigneeId:void 0,remark:""}),b=_({solution:"",result:"resolved",remark:""}),re={assigneeId:[{required:!0,message:"请选择处理人员",trigger:"change"}]},de={solution:[{required:!0,message:"请输入处理方法",trigger:"blur"}],result:[{required:!0,message:"请选择处理结果",trigger:"change"}]};async function T(){if(!w)return;B.value=!0;const{data:s}=await Fe(w);if(!s){q.replace("/business/ticket/list");return}l.value={...s},await h(),J.value=[],B.value=!1}function K(){if(!l.value.deadline||l.value.status==="completed"||l.value.status==="closed")return"-";const s=new Date,u=new Date(l.value.deadline)-s;if(u<=0)return"已超时";const i=Math.floor(u/(1e3*60*60)),C=Math.floor(u%(1e3*60*60)/(1e3*60));return`${i}小时${C}分钟`}function ce(){const s=K();return s==="已超时"?"danger":s.includes("小时")&&parseInt(s)<2?"warning":"success"}function me(){v.$modal.msgWarning("工单已超时，请尽快处理")}function pe(){q.push(`/business/ticket/edit/${w}?from=detail`)}function _e(){V.value={assigneeId:void 0,remark:""},$.value=!0,X()}function fe(){v.$refs.assignRef.validate(async s=>{if(!s)return;const e=F.value.find(u=>u.userId===V.value.assigneeId);e&&(await Me({ticketIds:[w],assigneeId:e.userId,assigneeName:e.nickName}),v.$modal.msgSuccess("指派成功"),$.value=!1,T())})}function ve(){v.$modal.confirm("确认开始处理该工单吗？").then(async()=>{await R.post(`/business/ticket/start/${w}`),v.$modal.msgSuccess("已开始处理"),T()}).catch(()=>{})}function ge(){b.value={solution:"",result:"resolved",remark:""},D.value=!0}function ke(){v.$refs.completeRef.validate(async s=>{s&&(await R.post("/business/ticket/complete",{ticketId:w,solution:b.value.solution,result:b.value.result}),v.$modal.msgSuccess("工单已完成"),D.value=!1,T())})}function be(){v.$modal.confirm("确认关闭该工单吗？").then(async()=>{await R.post(`/business/ticket/close/${w}`),v.$modal.msgSuccess("工单已关闭"),T()}).catch(()=>{})}function ye(){v.$modal.confirm("确认重新打开该工单？").then(async()=>{await He(w),v.$modal.msgSuccess("工单已重新打开"),T()}).catch(()=>{})}function we(){window.print()}function Q(){q.back()}function X(){F.value=[{userId:1,nickName:"张三"},{userId:2,nickName:"李四"},{userId:3,nickName:"王五"}]}ne(()=>{T(),X()});const Ce=je(()=>{if(!l.value.deadline)return Date.now();if(typeof l.value.deadline=="number")return l.value.deadline;const e=new Date(String(l.value.deadline).replace(/-/g,"/")).getTime();return isNaN(e)?Date.now():e});async function h(){const{pageNum:s,pageSize:e}=g.value,u={pageNum:s,pageSize:e};k.value.action&&(u.action=k.value.action),k.value.daterange&&k.value.daterange.length===2&&(u.beginTime=k.value.daterange[0],u.endTime=k.value.daterange[1]);const i=await R.get(`/business/ticket/${w}/logs`,{params:u}),C=i.rows||i.data||[];j.value=C,g.value.total=i.total||0;const L=C.find(M=>M.action==="start");W.value=L?L.createTime:""}function Ve(s){g.value.pageNum=s,h()}function Te(s){g.value.pageSize=s,h()}function Ne(){k.value={action:"",daterange:[]},g.value.pageNum=1,h()}function Z(){g.value.pageNum=1,h()}function Ie(s){const e=(H||[]).find(u=>u.value===s);return e?e.label:s}function Se(s){switch(s){case"create":return"primary";case"assign":return"info";case"start":return"warning";case"complete":return"success";case"close":return"danger";case"reopen":return"warning";default:return""}}return(s,e)=>{const u=c("el-button"),i=c("el-descriptions-item"),C=c("dict-tag"),L=c("el-countdown"),M=c("el-tag"),I=c("el-descriptions"),$e=c("Document"),De=c("el-icon"),he=c("el-link"),ee=c("el-option"),te=c("el-select"),ze=c("el-date-picker"),Le=c("el-timeline-item"),Re=c("el-timeline"),xe=c("el-pagination"),Ue=c("el-card"),z=c("el-form-item"),A=c("el-input"),ae=c("el-form"),le=c("el-dialog"),E=c("el-radio"),Pe=c("el-radio-group"),S=se("hasPermi"),qe=se("loading");return d(),y("div",Ge,[N((d(),p(Ue,null,{header:t(()=>[m("div",Je,[m("span",We,"工单详情 - "+r(l.value.ticketNo),1),m("div",Ke,[a(u,{link:"",type:"primary",icon:"Refresh",onClick:T},{default:t(()=>e[11]||(e[11]=[o("刷新")])),_:1,__:[11]}),a(u,{link:"",type:"primary",icon:"Close",onClick:Q},{default:t(()=>e[12]||(e[12]=[o("关闭")])),_:1,__:[12]})])])]),default:t(()=>[a(I,{column:3,border:"",class:"margin-bottom"},{title:t(()=>e[13]||(e[13]=[m("span",{class:"descriptions-title"},"基础信息",-1)])),default:t(()=>[a(i,{label:"工单编号"},{default:t(()=>[m("span",Qe,r(l.value.ticketNo),1)]),_:1}),a(i,{label:"工单状态"},{default:t(()=>[a(C,{options:x(oe),value:l.value.status},null,8,["options","value"])]),_:1}),a(i,{label:"最新动作"},{default:t(()=>[a(C,{options:x(H),value:l.value.lastAction},null,8,["options","value"])]),_:1}),a(i,{label:"最新状态时间"},{default:t(()=>[o(r(s.parseTime(l.value.lastStatusTime)||"-"),1)]),_:1}),a(i,{label:"优先级"},{default:t(()=>[a(C,{options:x(ie),value:l.value.priority},null,8,["options","value"])]),_:1}),a(i,{label:"工单标题",span:3},{default:t(()=>[o(r(l.value.title),1)]),_:1}),a(i,{label:"处理时限"},{default:t(()=>[l.value.status!=="completed"&&l.value.status!=="closed"?(d(),p(L,{key:0,value:Ce.value,format:"HH:mm:ss",onFinish:me},null,8,["value"])):(d(),y("span",Xe,r(s.parseTime(l.value.deadline)),1))]),_:1}),a(i,{label:"剩余时间"},{default:t(()=>[a(M,{type:ce()},{default:t(()=>[o(r(K()),1)]),_:1},8,["type"])]),_:1}),a(i,{label:"指派给"},{default:t(()=>[o(r(l.value.assigneeName||"未指派"),1)]),_:1})]),_:1}),a(I,{column:2,border:"",class:"margin-bottom"},{title:t(()=>e[14]||(e[14]=[m("span",{class:"descriptions-title"},"报修信息",-1)])),default:t(()=>[a(i,{label:"报修人"},{default:t(()=>[o(r(l.value.reporterName),1)]),_:1}),a(i,{label:"联系电话"},{default:t(()=>[o(r(l.value.reporterPhone||"-"),1)]),_:1}),a(i,{label:"报修时间"},{default:t(()=>[o(r(s.parseTime(l.value.createTime)),1)]),_:1}),a(i,{label:"发现时间"},{default:t(()=>[o(r(s.parseTime(l.value.discoveryTime)),1)]),_:1})]),_:1}),a(I,{column:2,border:"",class:"margin-bottom"},{title:t(()=>e[15]||(e[15]=[m("span",{class:"descriptions-title"},"故障信息",-1)])),default:t(()=>[a(i,{label:"故障设备"},{default:t(()=>[o(r(l.value.equipment),1)]),_:1}),a(i,{label:"设备专业"},{default:t(()=>[a(C,{options:x(ue),value:l.value.specialty},null,8,["options","value"])]),_:1}),a(i,{label:"设备位置",span:2},{default:t(()=>[o(r(l.value.location||"-"),1)]),_:1}),a(i,{label:"故障描述",span:2},{default:t(()=>[m("div",Ze,r(l.value.description),1)]),_:1}),a(i,{label:"应急处置",span:2},{default:t(()=>[m("div",et,r(l.value.emergencyAction||"无"),1)]),_:1})]),_:1}),l.value.status!=="pending"?(d(),p(I,{key:0,column:2,border:"",class:"margin-bottom"},{title:t(()=>e[16]||(e[16]=[m("span",{class:"descriptions-title"},"处理信息",-1)])),default:t(()=>[a(i,{label:"处理人"},{default:t(()=>[o(r(l.value.assigneeName||"-"),1)]),_:1}),a(i,{label:"开始时间"},{default:t(()=>[o(r(s.parseTime(W.value)||"-"),1)]),_:1}),a(i,{label:"处理方法",span:2},{default:t(()=>[m("div",tt,r(l.value.solution||"处理中..."),1)]),_:1}),l.value.status==="completed"||l.value.status==="closed"?(d(),p(i,{key:0,label:"完成时间"},{default:t(()=>[o(r(s.parseTime(l.value.completionTime)),1)]),_:1})):f("",!0),l.value.status==="completed"||l.value.status==="closed"?(d(),p(i,{key:1,label:"处理耗时"},{default:t(()=>[o(r(l.value.duration||"-"),1)]),_:1})):f("",!0)]),_:1})):f("",!0),l.value.attachments?(d(),p(I,{key:1,column:1,border:"",class:"margin-bottom"},{title:t(()=>e[17]||(e[17]=[m("span",{class:"descriptions-title"},"附件信息",-1)])),default:t(()=>[a(i,{label:"附件列表"},{default:t(()=>[m("div",at,[(d(!0),y(U,null,P(J.value,(n,O)=>(d(),y("div",{key:O,class:"attachment-item"},[a(he,{href:n.url,target:"_blank",underline:!1},{default:t(()=>[a(De,null,{default:t(()=>[a($e)]),_:1}),o(" "+r(n.name),1)]),_:2},1032,["href"])]))),128))])]),_:1})]),_:1})):f("",!0),a(I,{column:1,border:"",class:"margin-bottom"},{title:t(()=>e[18]||(e[18]=[m("span",{class:"descriptions-title"},"操作日志",-1)])),default:t(()=>[a(i,{label:""},{default:t(()=>[m("div",lt,[a(te,{modelValue:k.value.action,"onUpdate:modelValue":e[0]||(e[0]=n=>k.value.action=n),placeholder:"动作",clearable:"",size:"small",style:{width:"130px","margin-right":"8px"},onChange:Z},{default:t(()=>[(d(!0),y(U,null,P(G.value,n=>(d(),p(ee,{key:n.value,label:n.label,value:n.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),a(ze,{modelValue:k.value.daterange,"onUpdate:modelValue":e[1]||(e[1]=n=>k.value.daterange=n),type:"datetimerange","range-separator":"至","start-placeholder":"开始时间","end-placeholder":"结束时间",size:"small","value-format":"YYYY-MM-DD HH:mm:ss",onChange:Z,style:{"margin-right":"8px"}},null,8,["modelValue"]),a(u,{size:"small",icon:"Refresh",onClick:Ne},{default:t(()=>e[19]||(e[19]=[o("重置")])),_:1,__:[19]})]),a(Re,null,{default:t(()=>[(d(!0),y(U,null,P(j.value,(n,O)=>(d(),p(Le,{key:O,timestamp:s.parseTime(n.createTime),placement:"top",type:Se(n.action)},{default:t(()=>[m("div",nt,[m("span",st,r(n.operatorName||n.userName||"-"),1),m("span",ot,[o(r(Ie(n.action)),1),n.oldStatus||n.newStatus?(d(),y("span",it,"："+r(n.oldStatus||"-")+" → "+r(n.newStatus||"-"),1)):f("",!0)]),n.remark?(d(),y("div",ut,"备注："+r(n.remark),1)):f("",!0)])]),_:2},1032,["timestamp","type"]))),128))]),_:1}),g.value.total>g.value.pageSize?(d(),y("div",rt,[a(xe,{small:"",background:"",layout:"prev, pager, next, sizes, total",total:g.value.total,"page-size":g.value.pageSize,"current-page":g.value.pageNum,onCurrentChange:Ve,onSizeChange:Te,"page-sizes":[5,10,20,50]},null,8,["total","page-size","current-page"])])):f("",!0)]),_:1})]),_:1}),m("div",dt,[l.value.status!=="closed"?N((d(),p(u,{key:0,type:"primary",icon:"Edit",onClick:pe},{default:t(()=>e[20]||(e[20]=[o("编辑")])),_:1,__:[20]})),[[S,["business:ticket:edit"]]]):f("",!0),l.value.status==="pending"?N((d(),p(u,{key:1,type:"success",icon:"User",onClick:_e},{default:t(()=>e[21]||(e[21]=[o("指派")])),_:1,__:[21]})),[[S,["business:ticket:edit"]]]):f("",!0),l.value.status==="assigned"?N((d(),p(u,{key:2,type:"warning",icon:"VideoPlay",onClick:ve},{default:t(()=>e[22]||(e[22]=[o("开始处理")])),_:1,__:[22]})),[[S,["business:ticket:edit"]]]):f("",!0),l.value.status==="processing"?N((d(),p(u,{key:3,type:"success",icon:"CircleCheck",onClick:ge},{default:t(()=>e[23]||(e[23]=[o("完成工单")])),_:1,__:[23]})),[[S,["business:ticket:edit"]]]):f("",!0),l.value.status==="completed"?N((d(),p(u,{key:4,type:"danger",icon:"CircleClose",onClick:be},{default:t(()=>e[24]||(e[24]=[o("关闭工单")])),_:1,__:[24]})),[[S,["business:ticket:edit"]]]):f("",!0),l.value.status==="closed"?N((d(),p(u,{key:5,type:"warning",icon:"RefreshLeft",onClick:ye},{default:t(()=>e[25]||(e[25]=[o("重新打开")])),_:1,__:[25]})),[[S,["business:ticket:reopen"]]]):f("",!0),a(u,{type:"info",icon:"Printer",onClick:we},{default:t(()=>e[26]||(e[26]=[o("打印")])),_:1,__:[26]}),a(u,{icon:"Back",onClick:Q},{default:t(()=>e[27]||(e[27]=[o("返回")])),_:1,__:[27]})])]),_:1})),[[qe,B.value]]),a(le,{title:"指派工单",modelValue:$.value,"onUpdate:modelValue":e[5]||(e[5]=n=>$.value=n),width:"500px","append-to-body":""},{footer:t(()=>[m("div",ct,[a(u,{type:"primary",onClick:fe},{default:t(()=>e[28]||(e[28]=[o("确 定")])),_:1,__:[28]}),a(u,{onClick:e[4]||(e[4]=n=>$.value=!1)},{default:t(()=>e[29]||(e[29]=[o("取 消")])),_:1,__:[29]})])]),default:t(()=>[a(ae,{ref:"assignRef",model:V.value,rules:re,"label-width":"80px"},{default:t(()=>[a(z,{label:"指派给",prop:"assigneeId"},{default:t(()=>[a(te,{modelValue:V.value.assigneeId,"onUpdate:modelValue":e[2]||(e[2]=n=>V.value.assigneeId=n),placeholder:"请选择处理人员"},{default:t(()=>[(d(!0),y(U,null,P(F.value,n=>(d(),p(ee,{key:n.userId,label:n.nickName,value:n.userId},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),a(z,{label:"备注",prop:"remark"},{default:t(()=>[a(A,{modelValue:V.value.remark,"onUpdate:modelValue":e[3]||(e[3]=n=>V.value.remark=n),type:"textarea",rows:3,placeholder:"请输入备注"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),a(le,{title:"完成工单",modelValue:D.value,"onUpdate:modelValue":e[10]||(e[10]=n=>D.value=n),width:"600px","append-to-body":""},{footer:t(()=>[m("div",mt,[a(u,{type:"primary",onClick:ke},{default:t(()=>e[33]||(e[33]=[o("确 定")])),_:1,__:[33]}),a(u,{onClick:e[9]||(e[9]=n=>D.value=!1)},{default:t(()=>e[34]||(e[34]=[o("取 消")])),_:1,__:[34]})])]),default:t(()=>[a(ae,{ref:"completeRef",model:b.value,rules:de,"label-width":"100px"},{default:t(()=>[a(z,{label:"处理方法",prop:"solution"},{default:t(()=>[a(A,{modelValue:b.value.solution,"onUpdate:modelValue":e[6]||(e[6]=n=>b.value.solution=n),type:"textarea",rows:4,placeholder:"请输入处理方法"},null,8,["modelValue"])]),_:1}),a(z,{label:"处理结果",prop:"result"},{default:t(()=>[a(Pe,{modelValue:b.value.result,"onUpdate:modelValue":e[7]||(e[7]=n=>b.value.result=n)},{default:t(()=>[a(E,{label:"resolved"},{default:t(()=>e[30]||(e[30]=[o("已解决")])),_:1,__:[30]}),a(E,{label:"temporary"},{default:t(()=>e[31]||(e[31]=[o("临时处理")])),_:1,__:[31]}),a(E,{label:"transferred"},{default:t(()=>e[32]||(e[32]=[o("转其他部门")])),_:1,__:[32]})]),_:1},8,["modelValue"])]),_:1}),a(z,{label:"备注",prop:"remark"},{default:t(()=>[a(A,{modelValue:b.value.remark,"onUpdate:modelValue":e[8]||(e[8]=n=>b.value.remark=n),type:"textarea",rows:3,placeholder:"请输入备注"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}}),yt=Be(_t,[["__scopeId","data-v-453852e8"]]);export{yt as default};
