import{k as Ie,g as Me,r as _,P as Be,a7 as je,d as De,ac as s,ag as ue,l as $,m as i,D as g,J as l,K as se,C as t,Z as Le,u,I as B,$ as j,B as v,G as o,H as p,E as V,q as P}from"./vue-SR65qDCS.js";import{m as K,n as qe,o as Ae,q as Oe,v as He,w as Fe}from"./index-Cw83YE5u.js";import{l as ze}from"./user-brpwFzy8.js";import"./element-D8D5Bqo2.js";import"./vendor-C71Ev03J.js";const Ee={class:"app-container"},Ke=["innerHTML"],Qe={style:{"font-weight":"bold"}},We={style:{margin:"0 10px"}},Ge={key:0,style:{"margin-top":"5px",color:"#909399"}},Je={class:"dialog-footer"},Ze={class:"dialog-footer"},Xe=Ie({name:"MaintenanceApproval"}),ol=Object.assign(Xe,{setup(Ye){const{proxy:w}=Me(),Q=_([]),D=_(!0),L=_(!0),S=_([]),re=_(!0),q=_(!0),A=_(0),U=_(!1),k=_(!1),N=_(""),r=_({}),W=_([]),G=_([]),h=_(!1),{mop_category:O,approval_status:J}=w.useDict("mop_category","approval_status"),ie=Be({queryParams:{pageNum:1,pageSize:10,title:void 0,floor:void 0,mopCategory:void 0,approvalStatus:"pending"},approvalForm:{planIds:[],result:"approved",comment:"",notifyTypes:["system"]}}),{queryParams:f,approvalForm:d}=je(ie),pe={comment:[{required:!0,message:"请输入审批意见",trigger:"blur"},{min:5,max:200,message:"审批意见长度在 5 到 200 个字符",trigger:"blur"}]};function x(){D.value=!0,qe(f.value).then(n=>{Q.value=n.rows,A.value=n.total,D.value=!1})}function Z(n){return{1:"1楼",2:"2楼",3:"3楼",4:"4楼",all:"全部楼层"}[n]||n}function de(n){return n.mopCategory==="emergency"?!0:n.submitTime?Math.floor((new Date-new Date(n.submitTime))/864e5)>3:!1}function me(n){return n.approvalTime?Math.floor((new Date-new Date(n.approvalTime))/36e5)<24:!1}function H(){f.value.pageNum=1,x()}function ve(){w.resetForm("queryRef"),f.value.approvalStatus="pending",H()}function fe(n){S.value=n.map(e=>e.planId),re.value=n.length!=1,q.value=!n.length}function _e(n){r.value=n,U.value=!0,Ae(n.planId).then(e=>{W.value=e.rows})}function X(n){h.value=!1,d.value={planIds:[n.planId],result:"approved",comment:"同意执行",notifyTypes:["system"]},N.value=`通过维保计划：${n.title}`,k.value=!0}function Y(n){h.value=!1,d.value={planIds:[n.planId],result:"rejected",comment:"",notifyTypes:["system"]},N.value=`拒绝维保计划：${n.title}`,k.value=!0}function ce(){if(S.value.length===0){w.$modal.msgWarning("请先选择要审批的计划");return}h.value=!0,d.value={planIds:S.value,result:"approved",comment:"批量审批通过",notifyTypes:["system"]},N.value=`批量通过 ${S.value.length} 个维保计划`,k.value=!0}function be(){if(S.value.length===0){w.$modal.msgWarning("请先选择要审批的计划");return}h.value=!0,d.value={planIds:S.value,result:"rejected",comment:"",notifyTypes:["system"]},N.value=`批量拒绝 ${S.value.length} 个维保计划`,k.value=!0}function ge(n){w.$modal.confirm("是否确认撤回该审批？").then(()=>Oe(n.planId)).then(()=>{w.$modal.msgSuccess("撤回成功"),x()}).catch(()=>{})}function ye(){w.$refs.approvalRef.validate(n=>{if(n){const e=d.value.result==="approved";(e?He(d.value.planIds,d.value.comment,d.value.notifyTypes):Fe(d.value.planIds,d.value.comment)).then(y=>{w.$modal.msgSuccess(e?"审批通过":"审批拒绝"),k.value=!1,U.value=!1,x()})}})}function we(n){const e=G.value.find(R=>R.userId===n);return e?e.nickName:n}function ee(n){return{submit:"提交审批",approved:"审批通过",rejected:"审批拒绝",revoked:"撤回审批"}[n]||n}function le(n){return{submit:"primary",approved:"success",rejected:"danger",revoked:"warning"}[n]||"info"}function ke(){ze({status:"0"}).then(n=>{G.value=n.rows})}return De(()=>{x(),ke()}),(n,e)=>{const R=s("el-input"),y=s("el-form-item"),T=s("el-option"),F=s("el-select"),c=s("el-button"),te=s("el-form"),ae=s("el-col"),Ce=s("right-toolbar"),Ve=s("el-row"),b=s("el-table-column"),I=s("el-tag"),z=s("dict-tag"),Se=s("el-table"),Te=s("pagination"),m=s("el-descriptions-item"),xe=s("el-descriptions"),$e=s("el-divider"),Pe=s("el-timeline-item"),Ue=s("el-timeline"),ne=s("el-dialog"),oe=s("el-radio"),Ne=s("el-radio-group"),E=s("el-checkbox"),he=s("el-checkbox-group"),C=ue("hasPermi"),Re=ue("loading");return i(),$("div",Ee,[g(l(te,{model:u(f),ref:"queryRef",inline:!0,"label-width":"68px"},{default:t(()=>[l(y,{label:"计划标题",prop:"title"},{default:t(()=>[l(R,{modelValue:u(f).title,"onUpdate:modelValue":e[0]||(e[0]=a=>u(f).title=a),placeholder:"请输入计划标题",clearable:"",onKeyup:Le(H,["enter"])},null,8,["modelValue"])]),_:1}),l(y,{label:"楼层",prop:"floor"},{default:t(()=>[l(F,{modelValue:u(f).floor,"onUpdate:modelValue":e[1]||(e[1]=a=>u(f).floor=a),placeholder:"请选择楼层",clearable:""},{default:t(()=>[l(T,{label:"1楼",value:"1"}),l(T,{label:"2楼",value:"2"}),l(T,{label:"3楼",value:"3"}),l(T,{label:"4楼",value:"4"}),l(T,{label:"全部楼层",value:"all"})]),_:1},8,["modelValue"])]),_:1}),l(y,{label:"MOP类别",prop:"mopCategory"},{default:t(()=>[l(F,{modelValue:u(f).mopCategory,"onUpdate:modelValue":e[2]||(e[2]=a=>u(f).mopCategory=a),placeholder:"请选择类别",clearable:""},{default:t(()=>[(i(!0),$(B,null,j(u(O),a=>(i(),v(T,{key:a.value,label:a.label,value:a.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),l(y,{label:"审批状态",prop:"approvalStatus"},{default:t(()=>[l(F,{modelValue:u(f).approvalStatus,"onUpdate:modelValue":e[3]||(e[3]=a=>u(f).approvalStatus=a),placeholder:"请选择状态",clearable:""},{default:t(()=>[(i(!0),$(B,null,j(u(J),a=>(i(),v(T,{key:a.value,label:a.label,value:a.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),l(y,null,{default:t(()=>[l(c,{type:"primary",icon:"Search",onClick:H},{default:t(()=>e[16]||(e[16]=[o("搜索")])),_:1,__:[16]}),l(c,{icon:"Refresh",onClick:ve},{default:t(()=>e[17]||(e[17]=[o("重置")])),_:1,__:[17]})]),_:1})]),_:1},8,["model"]),[[se,L.value]]),l(Ve,{gutter:10,class:"mb8"},{default:t(()=>[l(ae,{span:1.5},{default:t(()=>[g((i(),v(c,{type:"success",plain:"",icon:"Select",disabled:q.value,onClick:ce},{default:t(()=>e[18]||(e[18]=[o("批量通过")])),_:1,__:[18]},8,["disabled"])),[[C,["business:maintenance:approve"]]])]),_:1}),l(ae,{span:1.5},{default:t(()=>[g((i(),v(c,{type:"danger",plain:"",icon:"CloseBold",disabled:q.value,onClick:be},{default:t(()=>e[19]||(e[19]=[o("批量拒绝")])),_:1,__:[19]},8,["disabled"])),[[C,["business:maintenance:approve"]]])]),_:1}),l(Ce,{showSearch:L.value,"onUpdate:showSearch":e[4]||(e[4]=a=>L.value=a),onQueryTable:x},null,8,["showSearch"])]),_:1}),g((i(),v(Se,{data:Q.value,onSelectionChange:fe},{default:t(()=>[l(b,{type:"selection",width:"55",align:"center"}),l(b,{label:"计划编号",align:"center",prop:"planNo",width:"120"}),l(b,{label:"计划标题",align:"left",prop:"title","show-overflow-tooltip":!0}),l(b,{label:"楼层",align:"center",prop:"floor",width:"80"},{default:t(a=>[l(I,null,{default:t(()=>[o(p(Z(a.row.floor)),1)]),_:2},1024)]),_:1}),l(b,{label:"版本",align:"center",prop:"version",width:"80"}),l(b,{label:"MOP类别",align:"center",prop:"mopCategory",width:"100"},{default:t(a=>[l(z,{options:u(O),value:a.row.mopCategory},null,8,["options","value"])]),_:1}),l(b,{label:"执行周期",align:"center",prop:"executionCycle",width:"100"}),l(b,{label:"申请人",align:"center",prop:"applicantName",width:"100"}),l(b,{label:"申请时间",align:"center",prop:"submitTime",width:"160"},{default:t(a=>[o(p(u(K)(a.row.submitTime)),1)]),_:1}),l(b,{label:"审批状态",align:"center",prop:"approvalStatus",width:"100"},{default:t(a=>[l(z,{options:u(J),value:a.row.approvalStatus},null,8,["options","value"])]),_:1}),l(b,{label:"优先级",align:"center",prop:"priority",width:"80"},{default:t(a=>[de(a.row)?(i(),v(I,{key:0,type:"danger"},{default:t(()=>e[20]||(e[20]=[o("紧急")])),_:1,__:[20]})):(i(),v(I,{key:1,type:"info"},{default:t(()=>e[21]||(e[21]=[o("普通")])),_:1,__:[21]}))]),_:1}),l(b,{label:"操作",align:"center","class-name":"small-padding fixed-width",width:"200"},{default:t(a=>[g((i(),v(c,{link:"",type:"primary",icon:"View",onClick:M=>_e(a.row)},{default:t(()=>e[22]||(e[22]=[o("查看")])),_:2,__:[22]},1032,["onClick"])),[[C,["business:maintenance:query"]]]),a.row.approvalStatus==="pending"?g((i(),v(c,{key:0,link:"",type:"success",icon:"Select",onClick:M=>X(a.row)},{default:t(()=>e[23]||(e[23]=[o("通过")])),_:2,__:[23]},1032,["onClick"])),[[C,["business:maintenance:approve"]]]):V("",!0),a.row.approvalStatus==="pending"?g((i(),v(c,{key:1,link:"",type:"danger",icon:"CloseBold",onClick:M=>Y(a.row)},{default:t(()=>e[24]||(e[24]=[o("拒绝")])),_:2,__:[24]},1032,["onClick"])),[[C,["business:maintenance:approve"]]]):V("",!0),a.row.approvalStatus!=="pending"&&me(a.row)?g((i(),v(c,{key:2,link:"",type:"warning",icon:"RefreshRight",onClick:M=>ge(a.row)},{default:t(()=>e[25]||(e[25]=[o("撤回")])),_:2,__:[25]},1032,["onClick"])),[[C,["business:maintenance:approve"]]]):V("",!0)]),_:1})]),_:1},8,["data"])),[[Re,D.value]]),g(l(Te,{total:A.value,page:u(f).pageNum,"onUpdate:page":e[5]||(e[5]=a=>u(f).pageNum=a),limit:u(f).pageSize,"onUpdate:limit":e[6]||(e[6]=a=>u(f).pageSize=a),onPagination:x},null,8,["total","page","limit"]),[[se,A.value>0]]),l(ne,{title:"维保计划详情",modelValue:U.value,"onUpdate:modelValue":e[10]||(e[10]=a=>U.value=a),width:"900px","append-to-body":""},{footer:t(()=>[P("div",Je,[l(c,{onClick:e[7]||(e[7]=a=>U.value=!1)},{default:t(()=>e[27]||(e[27]=[o("关 闭")])),_:1,__:[27]}),r.value.approvalStatus==="pending"?g((i(),v(c,{key:0,type:"success",onClick:e[8]||(e[8]=a=>X(r.value))},{default:t(()=>e[28]||(e[28]=[o("通 过")])),_:1,__:[28]})),[[C,["business:maintenance:approve"]]]):V("",!0),r.value.approvalStatus==="pending"?g((i(),v(c,{key:1,type:"danger",onClick:e[9]||(e[9]=a=>Y(r.value))},{default:t(()=>e[29]||(e[29]=[o("拒 绝")])),_:1,__:[29]})),[[C,["business:maintenance:approve"]]]):V("",!0)])]),default:t(()=>[l(xe,{column:2,border:""},{default:t(()=>[l(m,{label:"计划编号"},{default:t(()=>[o(p(r.value.planNo),1)]),_:1}),l(m,{label:"计划标题"},{default:t(()=>[o(p(r.value.title),1)]),_:1}),l(m,{label:"楼层"},{default:t(()=>[o(p(Z(r.value.floor)),1)]),_:1}),l(m,{label:"版本"},{default:t(()=>[o(p(r.value.version),1)]),_:1}),l(m,{label:"MOP类别"},{default:t(()=>[l(z,{options:u(O),value:r.value.mopCategory},null,8,["options","value"])]),_:1}),l(m,{label:"执行周期"},{default:t(()=>[o(p(r.value.executionCycle),1)]),_:1}),l(m,{label:"申请人"},{default:t(()=>[o(p(r.value.applicantName),1)]),_:1}),l(m,{label:"申请时间"},{default:t(()=>[o(p(u(K)(r.value.submitTime)),1)]),_:1}),l(m,{label:"MOP名称",span:2},{default:t(()=>[o(p(r.value.mopName),1)]),_:1}),l(m,{label:"MOP目的",span:2},{default:t(()=>[o(p(r.value.mopPurpose),1)]),_:1}),l(m,{label:"通知人员",span:2},{default:t(()=>[(i(!0),$(B,null,j(r.value.notifyUsers,a=>(i(),v(I,{key:a,style:{"margin-right":"5px"}},{default:t(()=>[o(p(we(a)),1)]),_:2},1024))),128))]),_:1}),l(m,{label:"工具仪表",span:2},{default:t(()=>[o(p(r.value.tools),1)]),_:1}),l(m,{label:"材料",span:2},{default:t(()=>[o(p(r.value.materials),1)]),_:1}),l(m,{label:"安全PPE",span:2},{default:t(()=>[o(p(r.value.safety),1)]),_:1}),l(m,{label:"特殊工具",span:2},{default:t(()=>[o(p(r.value.specialTools),1)]),_:1}),l(m,{label:"执行步骤",span:2},{default:t(()=>[P("div",{innerHTML:r.value.steps},null,8,Ke)]),_:1}),l(m,{label:"巡检结果",span:2},{default:t(()=>[o(p(r.value.inspectionResult||"待执行"),1)]),_:1}),l(m,{label:"备注",span:2},{default:t(()=>[o(p(r.value.remark),1)]),_:1})]),_:1}),l($e,{"content-position":"left"},{default:t(()=>e[26]||(e[26]=[o("审批历史")])),_:1,__:[26]}),l(Ue,null,{default:t(()=>[(i(!0),$(B,null,j(W.value,(a,M)=>(i(),v(Pe,{key:M,timestamp:u(K)(a.createTime),placement:"top",type:le(a.action)},{default:t(()=>[P("div",null,[P("span",Qe,p(a.userName),1),P("span",We,p(ee(a.action)),1),l(I,{type:le(a.action),size:"small"},{default:t(()=>[o(p(ee(a.action)),1)]),_:2},1032,["type"])]),a.comment?(i(),$("div",Ge," 审批意见："+p(a.comment),1)):V("",!0)]),_:2},1032,["timestamp","type"]))),128))]),_:1})]),_:1},8,["modelValue"]),l(ne,{title:N.value,modelValue:k.value,"onUpdate:modelValue":e[15]||(e[15]=a=>k.value=a),width:"500px","append-to-body":""},{footer:t(()=>[P("div",Ze,[l(c,{type:"primary",onClick:ye},{default:t(()=>e[35]||(e[35]=[o("确 定")])),_:1,__:[35]}),l(c,{onClick:e[14]||(e[14]=a=>k.value=!1)},{default:t(()=>e[36]||(e[36]=[o("取 消")])),_:1,__:[36]})])]),default:t(()=>[l(te,{ref:"approvalRef",model:u(d),rules:pe,"label-width":"80px"},{default:t(()=>[h.value?V("",!0):(i(),v(y,{key:0,label:"审批结果"},{default:t(()=>[l(Ne,{modelValue:u(d).result,"onUpdate:modelValue":e[11]||(e[11]=a=>u(d).result=a),disabled:!0},{default:t(()=>[l(oe,{label:"approved"},{default:t(()=>e[30]||(e[30]=[o("通过")])),_:1,__:[30]}),l(oe,{label:"rejected"},{default:t(()=>e[31]||(e[31]=[o("拒绝")])),_:1,__:[31]})]),_:1},8,["modelValue"])]),_:1})),l(y,{label:"审批意见",prop:"comment"},{default:t(()=>[l(R,{modelValue:u(d).comment,"onUpdate:modelValue":e[12]||(e[12]=a=>u(d).comment=a),type:"textarea",rows:4,placeholder:"请输入审批意见",maxlength:"200","show-word-limit":""},null,8,["modelValue"])]),_:1}),u(d).result==="approved"?(i(),v(y,{key:1,label:"通知方式"},{default:t(()=>[l(he,{modelValue:u(d).notifyTypes,"onUpdate:modelValue":e[13]||(e[13]=a=>u(d).notifyTypes=a)},{default:t(()=>[l(E,{label:"system"},{default:t(()=>e[32]||(e[32]=[o("系统通知")])),_:1,__:[32]}),l(E,{label:"email"},{default:t(()=>e[33]||(e[33]=[o("邮件通知")])),_:1,__:[33]}),l(E,{label:"sms"},{default:t(()=>e[34]||(e[34]=[o("短信通知")])),_:1,__:[34]})]),_:1},8,["modelValue"])]),_:1})):V("",!0)]),_:1},8,["model"])]),_:1},8,["title","modelValue"])])}}});export{ol as default};
