import{k as Te,g as Re,ar as Ee,r as g,P as Ne,a7 as Le,d as qe,ac as p,ag as le,l as $,m as r,D as f,J as a,K as ae,C as t,Z as Me,u as o,I as T,$ as R,B as m,G as u,H as O,E as C,q as te}from"./vue-SR65qDCS.js";import{m as ne,n as Fe,L as Ae,H as Be,J as Oe,G as ze,K as Ke,M as Ye,v as je,w as Ge}from"./index-Cw83YE5u.js";import"./element-D8D5Bqo2.js";import"./vendor-C71Ev03J.js";const Qe={class:"app-container"},He={key:0},Je={class:"dialog-footer"},We={class:"dialog-footer"},Ze=Te({name:"MaintenancePlan"}),ol=Object.assign(Ze,{setup(Xe){const{proxy:i}=Re(),h=Ee(),z=g([]),E=g([]),D=g(!1),V=g(!1),N=g(!0),L=g(!0),q=g([]),K=g(!0),Y=g(!0),M=g(0),U=g([]),j=g([]),G=g(!1),{mop_category:Q,approval_status:H,execution_status:J}=i.useDict("mop_category","approval_status","execution_status"),oe=Ne({queryParams:{pageNum:1,pageSize:10,title:void 0,floor:void 0,mopCategory:void 0,approvalStatus:void 0,executionStatus:void 0},submitForm:{planId:void 0,approverId:void 0,remark:""},approveForm:{planId:void 0,result:"approved",comment:""}}),{queryParams:d,form:el,submitForm:y,approveForm:c}=Le(oe),ue={approverId:[{required:!0,message:"请选择审核人",trigger:"change"}]},re={result:[{required:!0,message:"请选择审核结果",trigger:"change"}],comment:[{required:!0,message:"请输入审核意见",trigger:"blur"}]};function w(){N.value=!0;let n=i.addDateRange(d.value,U.value);Fe(n).then(e=>{z.value=e.rows,E.value=[...e.rows],M.value=e.total,N.value=!1})}function ie(n){return{1:"1楼",2:"2楼",3:"3楼",4:"4楼",all:"全部楼层"}[n]||n}function se(n){if(!n)return!1;const e=new Date,v=new Date(n)-e;return v>0&&v<2880*60*1e3}function F(){d.value.pageNum=1,w()}function de(){U.value=[],i.resetForm("queryRef"),F()}function pe(n){q.value=n.map(e=>e.planId),K.value=n.length!=1,Y.value=!n.length}function me(){h.push("/business/maintenance/plan/form")}function fe(){if(E.value.length>0){const n=E.value.sort((e,x)=>new Date(x.createTime)-new Date(e.createTime))[0];h.push("/business/maintenance/plan/form?copy="+n.planId)}else i.$modal.msgWarning("暂无可复制的维保计划")}function W(n){const e=n.planId||q.value[0];h.push("/business/maintenance/plan/form/"+e)}function ve(n){h.push("/business/maintenance/plan/detail/"+n.planId)}function ce(n){i.$modal.confirm("是否复制该维保计划？").then(()=>Be(n.planId)).then(()=>{i.$modal.msgSuccess("复制成功"),w()}).catch(()=>{})}function _e(n){Oe().then(e=>{j.value=e.rows,y.value.planId=n.planId,y.value.approverId=void 0,y.value.remark="",D.value=!0})}function ge(){i.$refs.submitRef.validate(n=>{n&&Ye(y.value.planId,y.value.approverId).then(e=>{i.$modal.msgSuccess("提交成功"),D.value=!1,w()})})}function be(n){c.value.planId=n.planId,c.value.result="approved",c.value.comment="",V.value=!0}function we(){i.$refs.approveRef.validate(n=>{n&&(c.value.result==="approved"?je(c.value.planId,c.value.comment).then(()=>{i.$modal.msgSuccess("审核通过"),V.value=!1,w()}):Ge(c.value.planId,c.value.comment).then(()=>{i.$modal.msgSuccess("审核拒绝"),V.value=!1,w()}))})}function ye(n){i.$modal.confirm("确认开始执行该维保计划吗？").then(()=>ze(n.planId)).then(()=>{i.$modal.msgSuccess("已开始执行"),w()}).catch(()=>{})}function ke(n){i.$modal.confirm("确认生成维保工单吗？").then(()=>Ke(n.planId)).then(()=>{i.$modal.msgSuccess("工单生成成功"),w()}).catch(()=>{})}function Ce(n){const e=n.planId||q.value;i.$modal.confirm('是否确认删除维保计划编号为"'+e+'"的数据项？').then(function(){return Ae(e)}).then(()=>{w(),i.$modal.msgSuccess("删除成功")}).catch(()=>{})}function Ve(){i.download("business/maintenance/export",{...d.value},`maintenance_${new Date().getTime()}.xlsx`)}function xe(){h.push("/business/maintenance/calendar")}return qe(()=>{w(),G.value=i.$auth.hasPermi("business:maintenance:approve")}),(n,e)=>{const x=p("el-input"),v=p("el-form-item"),k=p("el-option"),P=p("el-select"),Se=p("el-date-picker"),s=p("el-button"),A=p("el-form"),S=p("el-col"),Ie=p("right-toolbar"),$e=p("el-row"),_=p("el-table-column"),Z=p("el-tag"),B=p("dict-tag"),he=p("el-table"),De=p("pagination"),X=p("el-dialog"),ee=p("el-radio"),Pe=p("el-radio-group"),b=le("hasPermi"),Ue=le("loading");return r(),$("div",Qe,[f(a(A,{model:o(d),ref:"queryRef",inline:!0,"label-width":"68px"},{default:t(()=>[a(v,{label:"标题",prop:"title"},{default:t(()=>[a(x,{modelValue:o(d).title,"onUpdate:modelValue":e[0]||(e[0]=l=>o(d).title=l),placeholder:"请输入计划标题",clearable:"",onKeyup:Me(F,["enter"])},null,8,["modelValue"])]),_:1}),a(v,{label:"楼层",prop:"floor"},{default:t(()=>[a(P,{modelValue:o(d).floor,"onUpdate:modelValue":e[1]||(e[1]=l=>o(d).floor=l),placeholder:"请选择楼层",clearable:""},{default:t(()=>[a(k,{label:"1楼",value:"1"}),a(k,{label:"2楼",value:"2"}),a(k,{label:"3楼",value:"3"}),a(k,{label:"4楼",value:"4"}),a(k,{label:"全部楼层",value:"all"})]),_:1},8,["modelValue"])]),_:1}),a(v,{label:"MOP类别",prop:"mopCategory"},{default:t(()=>[a(P,{modelValue:o(d).mopCategory,"onUpdate:modelValue":e[2]||(e[2]=l=>o(d).mopCategory=l),placeholder:"请选择类别",clearable:""},{default:t(()=>[(r(!0),$(T,null,R(o(Q),l=>(r(),m(k,{key:l.value,label:l.label,value:l.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),a(v,{label:"审核状态",prop:"approvalStatus"},{default:t(()=>[a(P,{modelValue:o(d).approvalStatus,"onUpdate:modelValue":e[3]||(e[3]=l=>o(d).approvalStatus=l),placeholder:"请选择状态",clearable:""},{default:t(()=>[(r(!0),$(T,null,R(o(H),l=>(r(),m(k,{key:l.value,label:l.label,value:l.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),a(v,{label:"执行状态",prop:"executionStatus"},{default:t(()=>[a(P,{modelValue:o(d).executionStatus,"onUpdate:modelValue":e[4]||(e[4]=l=>o(d).executionStatus=l),placeholder:"请选择状态",clearable:""},{default:t(()=>[(r(!0),$(T,null,R(o(J),l=>(r(),m(k,{key:l.value,label:l.label,value:l.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),a(v,{label:"计划时间"},{default:t(()=>[a(Se,{modelValue:U.value,"onUpdate:modelValue":e[5]||(e[5]=l=>U.value=l),type:"daterange","range-separator":"至","start-placeholder":"开始日期","end-placeholder":"结束日期","value-format":"YYYY-MM-DD"},null,8,["modelValue"])]),_:1}),a(v,null,{default:t(()=>[a(s,{type:"primary",icon:"Search",onClick:F},{default:t(()=>e[17]||(e[17]=[u("搜索")])),_:1,__:[17]}),a(s,{icon:"Refresh",onClick:de},{default:t(()=>e[18]||(e[18]=[u("重置")])),_:1,__:[18]})]),_:1})]),_:1},8,["model"]),[[ae,L.value]]),a($e,{gutter:10,class:"mb8"},{default:t(()=>[a(S,{span:1.5},{default:t(()=>[f((r(),m(s,{type:"primary",plain:"",icon:"Plus",onClick:me},{default:t(()=>e[19]||(e[19]=[u("新建计划")])),_:1,__:[19]})),[[b,["business:maintenance:add"]]])]),_:1}),a(S,{span:1.5},{default:t(()=>[f((r(),m(s,{type:"success",plain:"",icon:"DocumentCopy",onClick:fe},{default:t(()=>e[20]||(e[20]=[u("复制上次")])),_:1,__:[20]})),[[b,["business:maintenance:add"]]])]),_:1}),a(S,{span:1.5},{default:t(()=>[f((r(),m(s,{type:"success",plain:"",icon:"Edit",disabled:K.value,onClick:W},{default:t(()=>e[21]||(e[21]=[u("修改")])),_:1,__:[21]},8,["disabled"])),[[b,["business:maintenance:edit"]]])]),_:1}),a(S,{span:1.5},{default:t(()=>[f((r(),m(s,{type:"danger",plain:"",icon:"Delete",disabled:Y.value,onClick:Ce},{default:t(()=>e[22]||(e[22]=[u("删除")])),_:1,__:[22]},8,["disabled"])),[[b,["business:maintenance:remove"]]])]),_:1}),a(S,{span:1.5},{default:t(()=>[f((r(),m(s,{type:"warning",plain:"",icon:"Download",onClick:Ve},{default:t(()=>e[23]||(e[23]=[u("导出")])),_:1,__:[23]})),[[b,["business:maintenance:export"]]])]),_:1}),a(S,{span:1.5},{default:t(()=>[a(s,{type:"info",plain:"",icon:"Calendar",onClick:xe},{default:t(()=>e[24]||(e[24]=[u("日历视图")])),_:1,__:[24]})]),_:1}),a(Ie,{showSearch:L.value,"onUpdate:showSearch":e[6]||(e[6]=l=>L.value=l),onQueryTable:w},null,8,["showSearch"])]),_:1}),f((r(),m(he,{data:z.value,onSelectionChange:pe},{default:t(()=>[a(_,{type:"selection",width:"55",align:"center"}),a(_,{label:"计划编号",align:"center",prop:"planNo",width:"120"}),a(_,{label:"标题",align:"left",prop:"title","show-overflow-tooltip":!0}),a(_,{label:"楼层",align:"center",prop:"floor",width:"80"},{default:t(l=>[a(Z,null,{default:t(()=>[u(O(ie(l.row.floor)),1)]),_:2},1024)]),_:1}),a(_,{label:"版本",align:"center",prop:"version",width:"80"}),a(_,{label:"MOP类别",align:"center",prop:"mopCategory",width:"100"},{default:t(l=>[a(B,{options:o(Q),value:l.row.mopCategory},null,8,["options","value"])]),_:1}),a(_,{label:"执行周期",align:"center",prop:"executionCycle",width:"100"}),a(_,{label:"审核状态",align:"center",prop:"approvalStatus",width:"100"},{default:t(l=>[a(B,{options:o(H),value:l.row.approvalStatus},null,8,["options","value"])]),_:1}),a(_,{label:"执行状态",align:"center",prop:"executionStatus",width:"100"},{default:t(l=>[a(B,{options:o(J),value:l.row.executionStatus},null,8,["options","value"])]),_:1}),a(_,{label:"审核人",align:"center",prop:"approverName",width:"100"}),a(_,{label:"下次执行",align:"center",prop:"nextExecutionTime",width:"160"},{default:t(l=>[l.row.nextExecutionTime?(r(),$("span",He,[u(O(o(ne)(l.row.nextExecutionTime,"{y}-{m}-{d} {h}:{i}"))+" ",1),se(l.row.nextExecutionTime)?(r(),m(Z,{key:0,type:"warning",size:"small"},{default:t(()=>e[25]||(e[25]=[u("即将到期")])),_:1,__:[25]})):C("",!0)])):C("",!0)]),_:1}),a(_,{label:"创建时间",align:"center",prop:"createTime",width:"160"},{default:t(l=>[u(O(o(ne)(l.row.createTime)),1)]),_:1}),a(_,{label:"操作",align:"center","class-name":"small-padding fixed-width",width:"240"},{default:t(l=>[f((r(),m(s,{link:"",type:"primary",icon:"View",onClick:I=>ve(l.row)},{default:t(()=>e[26]||(e[26]=[u("查看")])),_:2,__:[26]},1032,["onClick"])),[[b,["business:maintenance:query"]]]),l.row.approvalStatus!=="approved"?f((r(),m(s,{key:0,link:"",type:"primary",icon:"Edit",onClick:I=>W(l.row)},{default:t(()=>e[27]||(e[27]=[u("修改")])),_:2,__:[27]},1032,["onClick"])),[[b,["business:maintenance:edit"]]]):C("",!0),f((r(),m(s,{link:"",type:"success",icon:"DocumentCopy",onClick:I=>ce(l.row)},{default:t(()=>e[28]||(e[28]=[u("复制")])),_:2,__:[28]},1032,["onClick"])),[[b,["business:maintenance:add"]]]),l.row.approvalStatus==="draft"?f((r(),m(s,{key:1,link:"",type:"warning",icon:"Promotion",onClick:I=>_e(l.row)},{default:t(()=>e[29]||(e[29]=[u("提交")])),_:2,__:[29]},1032,["onClick"])),[[b,["business:maintenance:edit"]]]):C("",!0),l.row.approvalStatus==="pending"&&G.value?f((r(),m(s,{key:2,link:"",type:"success",icon:"Select",onClick:I=>be(l.row)},{default:t(()=>e[30]||(e[30]=[u("审核")])),_:2,__:[30]},1032,["onClick"])),[[b,["business:maintenance:approve"]]]):C("",!0),l.row.approvalStatus==="approved"&&l.row.executionStatus==="pending"?f((r(),m(s,{key:3,link:"",type:"primary",icon:"VideoPlay",onClick:I=>ye(l.row)},{default:t(()=>e[31]||(e[31]=[u("执行")])),_:2,__:[31]},1032,["onClick"])),[[b,["business:maintenance:execute"]]]):C("",!0),l.row.approvalStatus==="approved"?f((r(),m(s,{key:4,link:"",type:"warning",icon:"Tickets",onClick:I=>ke(l.row)},{default:t(()=>e[32]||(e[32]=[u("生成工单")])),_:2,__:[32]},1032,["onClick"])),[[b,["business:maintenance:ticket"]]]):C("",!0)]),_:1})]),_:1},8,["data"])),[[Ue,N.value]]),f(a(De,{total:M.value,page:o(d).pageNum,"onUpdate:page":e[7]||(e[7]=l=>o(d).pageNum=l),limit:o(d).pageSize,"onUpdate:limit":e[8]||(e[8]=l=>o(d).pageSize=l),onPagination:w},null,8,["total","page","limit"]),[[ae,M.value>0]]),a(X,{title:"提交审核",modelValue:D.value,"onUpdate:modelValue":e[12]||(e[12]=l=>D.value=l),width:"500px","append-to-body":""},{footer:t(()=>[te("div",Je,[a(s,{type:"primary",onClick:ge},{default:t(()=>e[33]||(e[33]=[u("确 定")])),_:1,__:[33]}),a(s,{onClick:e[11]||(e[11]=l=>D.value=!1)},{default:t(()=>e[34]||(e[34]=[u("取 消")])),_:1,__:[34]})])]),default:t(()=>[a(A,{ref:"submitRef",model:o(y),rules:ue,"label-width":"80px"},{default:t(()=>[a(v,{label:"审核人",prop:"approverId"},{default:t(()=>[a(P,{modelValue:o(y).approverId,"onUpdate:modelValue":e[9]||(e[9]=l=>o(y).approverId=l),placeholder:"请选择审核人"},{default:t(()=>[(r(!0),$(T,null,R(j.value,l=>(r(),m(k,{key:l.userId,label:l.nickName,value:l.userId},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),a(v,{label:"备注",prop:"remark"},{default:t(()=>[a(x,{modelValue:o(y).remark,"onUpdate:modelValue":e[10]||(e[10]=l=>o(y).remark=l),type:"textarea",rows:3,placeholder:"请输入备注"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),a(X,{title:"审核维保计划",modelValue:V.value,"onUpdate:modelValue":e[16]||(e[16]=l=>V.value=l),width:"500px","append-to-body":""},{footer:t(()=>[te("div",We,[a(s,{type:"primary",onClick:we},{default:t(()=>e[37]||(e[37]=[u("确 定")])),_:1,__:[37]}),a(s,{onClick:e[15]||(e[15]=l=>V.value=!1)},{default:t(()=>e[38]||(e[38]=[u("取 消")])),_:1,__:[38]})])]),default:t(()=>[a(A,{ref:"approveRef",model:o(c),rules:re,"label-width":"80px"},{default:t(()=>[a(v,{label:"审核结果",prop:"result"},{default:t(()=>[a(Pe,{modelValue:o(c).result,"onUpdate:modelValue":e[13]||(e[13]=l=>o(c).result=l)},{default:t(()=>[a(ee,{label:"approved"},{default:t(()=>e[35]||(e[35]=[u("通过")])),_:1,__:[35]}),a(ee,{label:"rejected"},{default:t(()=>e[36]||(e[36]=[u("拒绝")])),_:1,__:[36]})]),_:1},8,["modelValue"])]),_:1}),a(v,{label:"审核意见",prop:"comment"},{default:t(()=>[a(x,{modelValue:o(c).comment,"onUpdate:modelValue":e[14]||(e[14]=l=>o(c).comment=l),type:"textarea",rows:3,placeholder:"请输入审核意见"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}});export{ol as default};
