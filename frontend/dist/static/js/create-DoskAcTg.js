import{k as me,g as ce,ap as fe,ar as _e,r as N,c as P,d as ve,ac as i,l as f,m as r,J as t,q as s,C as o,B as h,E as x,G as d,H as p,I as w,$ as T,u as Y}from"./vue-SR65qDCS.js";import{_ as be,I,j as R,A as ye}from"./index-Cw83YE5u.js";import{g as ge,a as Ve,b as ke,u as he,c as xe}from"./inspection-INzddNo1.js";import"./element-D8D5Bqo2.js";import"./vendor-C71Ev03J.js";const Ie={class:"app-container"},Ue={class:"progress-info"},Ne={class:"ml10"},Ce={class:"inspection-items"},De={class:"item-index"},Oe={class:"item-content"},Se={class:"item-label"},$e={class:"item-input"},we={key:2,class:"ml10"},Te={class:"inspection-items"},Ye={class:"item-index"},Ae={class:"item-content"},Ee={class:"item-label"},je={class:"item-input"},Me={class:"inspection-items"},Pe={class:"item-index"},Re={class:"item-content"},Be={class:"item-label"},Je={class:"item-input"},Le={class:"inspection-items"},qe={class:"item-index"},ze={class:"item-content"},Ge={class:"item-label"},Fe={class:"item-input"},He={key:2,class:"ml10"},We={class:"mt20 text-center"},Ke=me({name:"InspectionCreate"}),Qe=Object.assign(Ke,{setup(Xe){const{proxy:U}=ce(),H=fe(),A=_e(),v=N(H.params.id),B=N("floor1"),C=N(!1),g=N([]),E=N(!0),n=N({inspectionDate:new Date().toISOString().split("T")[0],inspectorName:"",relayPerson:"",remark:"",items:{floor1:{},floor2:{},floor3:{},floor4:{}},photos:[]}),W={inspectionDate:[{required:!0,message:"请选择巡检日期",trigger:"change"}],inspectorName:[{required:!0,message:"请输入巡检人员",trigger:"blur"}]},J=P(()=>Object.values(I).reduce((a,e)=>a+e.length,0)),L=P(()=>{let a=0;return Object.keys(n.value.items).forEach(e=>{Object.values(n.value.items[e]).forEach(u=>{u!=null&&u!==""&&a++})}),a}),j=P(()=>Math.round(L.value/J.value*100));function q(a){const e={floor1:{},floor2:{},floor3:{},floor4:{}};if(!a)return e;if(typeof a=="string")try{const u=JSON.parse(a);return{...e,...u}}catch{return e}return{...e,...a}}function K(a){if(!a)return[];if(Array.isArray(a))return a;if(typeof a=="string")try{return JSON.parse(a)}catch{return[]}return[]}function Q(){Ve().then(a=>{a.data?(n.value.items=q(a.data.items),n.value.remark=`[复制自巡检#${a.data.inspectionNo}]`,U.$modal.msgSuccess("已复制上次巡检记录")):U.$modal.msgWarning("没有找到上次巡检记录")})}function X(){const a=[];return Object.keys(I).forEach(e=>{const u=I[e],b=n.value.items[e];u.forEach(m=>{const _=b[m.id];if(_==null)return;let V=!1;m.type==="boolean"?V=R.boolean(_):m.type==="number"&&R.number[m.id]&&(V=R.number[m.id](_)),V&&a.push({floor:e.replace("floor","")+"楼",itemId:m.id,itemName:m.label,value:_,priority:Z(m.label)})})}),a}function Z(a){for(const[e,u]of Object.entries(ye))if(u.some(b=>a.includes(b)))return e;return"low"}function ee(){U.$refs.inspectionRef.validate(a=>{a&&(g.value=X(),g.value.length>0?C.value=!0:z())})}function z(){const a={...n.value,items:JSON.stringify(n.value.items||{}),photos:JSON.stringify(n.value.photos||[]),anomalyCount:g.value.length,progress:j.value};return(v.value?he:xe)(a).then(u=>{var b;return!v.value&&((b=u==null?void 0:u.data)!=null&&b.inspectionId)&&(v.value=u.data.inspectionId),U.$modal.msgSuccess(v.value?"修改成功":"新增成功"),u})}function le(){const a=E.value&&g.value.length>0;C.value=!1,z().then(()=>{if(a){if(!v.value){U.$modal.msgError("未获取到巡检ID，无法生成工单");return}ke(v.value,g.value).then(e=>{U.$modal.msgSuccess(`已生成 ${(e.data||[]).length} 个工单`),A.push("/business/inspection")})}else A.push("/business/inspection")})}function te(){A.back()}function oe(a){return{high:"danger",medium:"warning",low:"info"}[a]||"info"}return ve(()=>{v.value&&ge(v.value).then(a=>{if(a.data){const{items:e,...u}=a.data;n.value={...n.value,...u,items:q(e),photos:K(u.photos)}}})}),(a,e)=>{const u=i("el-button"),b=i("el-date-picker"),m=i("el-form-item"),_=i("el-col"),V=i("el-input"),G=i("el-row"),ae=i("el-form"),D=i("el-card"),ne=i("el-progress"),M=i("el-tag"),y=i("el-radio"),O=i("el-radio-group"),F=i("el-input-number"),S=i("el-tab-pane"),se=i("el-tabs"),ue=i("image-upload"),ie=i("el-alert"),$=i("el-table-column"),de=i("el-table"),re=i("el-checkbox"),pe=i("el-dialog");return r(),f("div",Ie,[t(D,{class:"mb20"},{header:o(()=>[e[10]||(e[10]=s("span",null,"巡检基本信息",-1)),v.value?x("",!0):(r(),h(u,{key:0,type:"info",style:{float:"right"},onClick:Q},{default:o(()=>e[9]||(e[9]=[d("复制上次巡检")])),_:1,__:[9]}))]),default:o(()=>[t(ae,{ref:"inspectionRef",model:n.value,rules:W,"label-width":"100px"},{default:o(()=>[t(G,null,{default:o(()=>[t(_,{span:8},{default:o(()=>[t(m,{label:"巡检日期",prop:"inspectionDate"},{default:o(()=>[t(b,{modelValue:n.value.inspectionDate,"onUpdate:modelValue":e[0]||(e[0]=l=>n.value.inspectionDate=l),type:"date",placeholder:"选择日期",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD"},null,8,["modelValue"])]),_:1})]),_:1}),t(_,{span:8},{default:o(()=>[t(m,{label:"巡检人员",prop:"inspectorName"},{default:o(()=>[t(V,{modelValue:n.value.inspectorName,"onUpdate:modelValue":e[1]||(e[1]=l=>n.value.inspectorName=l),placeholder:"请输入巡检人员"},null,8,["modelValue"])]),_:1})]),_:1}),t(_,{span:8},{default:o(()=>[t(m,{label:"接力人员"},{default:o(()=>[t(V,{modelValue:n.value.relayPerson,"onUpdate:modelValue":e[2]||(e[2]=l=>n.value.relayPerson=l),placeholder:"接力人员（可选）"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),t(G,null,{default:o(()=>[t(_,{span:24},{default:o(()=>[t(m,{label:"备注"},{default:o(()=>[t(V,{modelValue:n.value.remark,"onUpdate:modelValue":e[3]||(e[3]=l=>n.value.remark=l),type:"textarea",placeholder:"请输入备注"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1})]),_:1},8,["model"])]),_:1}),t(D,{class:"mb20"},{default:o(()=>[s("div",Ue,[e[11]||(e[11]=s("span",null,"巡检进度：",-1)),t(ne,{percentage:j.value,status:j.value===100?"success":"",style:{width:"400px"}},null,8,["percentage","status"]),s("span",Ne,p(L.value)+"/"+p(J.value)+"项",1)])]),_:1}),t(D,null,{header:o(()=>e[12]||(e[12]=[s("span",null,"巡检项目",-1)])),default:o(()=>[t(se,{modelValue:B.value,"onUpdate:modelValue":e[4]||(e[4]=l=>B.value=l)},{default:o(()=>[t(S,{label:"1楼（22项）",name:"floor1"},{default:o(()=>[s("div",Ce,[(r(!0),f(w,null,T(Y(I).floor1,(l,k)=>(r(),f("div",{key:l.id,class:"inspection-item"},[s("div",De,p(k+1),1),s("div",Oe,[s("div",Se,[d(p(l.label)+" ",1),l.type==="number"?(r(),h(M,{key:0,size:"small",type:"info"},{default:o(()=>[d(p(l.unit),1)]),_:2},1024)):x("",!0)]),s("div",$e,[l.type==="boolean"?(r(),h(O,{key:0,modelValue:n.value.items.floor1[l.id],"onUpdate:modelValue":c=>n.value.items.floor1[l.id]=c},{default:o(()=>[t(y,{label:!0},{default:o(()=>e[13]||(e[13]=[d("正常")])),_:1,__:[13]}),t(y,{label:!1},{default:o(()=>e[14]||(e[14]=[d("异常")])),_:1,__:[14]})]),_:2},1032,["modelValue","onUpdate:modelValue"])):l.type==="number"?(r(),h(F,{key:1,modelValue:n.value.items.floor1[l.id],"onUpdate:modelValue":c=>n.value.items.floor1[l.id]=c,min:l.min,max:l.max,precision:2,"controls-position":"right"},null,8,["modelValue","onUpdate:modelValue","min","max"])):x("",!0),l.type==="number"?(r(),f("span",we,p(l.unit),1)):x("",!0)])])]))),128))])]),_:1}),t(S,{label:"2楼（18项）",name:"floor2"},{default:o(()=>[s("div",Te,[(r(!0),f(w,null,T(Y(I).floor2,(l,k)=>(r(),f("div",{key:l.id,class:"inspection-item"},[s("div",Ye,p(k+1),1),s("div",Ae,[s("div",Ee,p(l.label),1),s("div",je,[t(O,{modelValue:n.value.items.floor2[l.id],"onUpdate:modelValue":c=>n.value.items.floor2[l.id]=c},{default:o(()=>[t(y,{label:!0},{default:o(()=>e[15]||(e[15]=[d("正常")])),_:1,__:[15]}),t(y,{label:!1},{default:o(()=>e[16]||(e[16]=[d("异常")])),_:1,__:[16]})]),_:2},1032,["modelValue","onUpdate:modelValue"])])])]))),128))])]),_:1}),t(S,{label:"3楼（13项）",name:"floor3"},{default:o(()=>[s("div",Me,[(r(!0),f(w,null,T(Y(I).floor3,(l,k)=>(r(),f("div",{key:l.id,class:"inspection-item"},[s("div",Pe,p(k+1),1),s("div",Re,[s("div",Be,p(l.label),1),s("div",Je,[t(O,{modelValue:n.value.items.floor3[l.id],"onUpdate:modelValue":c=>n.value.items.floor3[l.id]=c},{default:o(()=>[t(y,{label:!0},{default:o(()=>e[17]||(e[17]=[d("正常")])),_:1,__:[17]}),t(y,{label:!1},{default:o(()=>e[18]||(e[18]=[d("异常")])),_:1,__:[18]})]),_:2},1032,["modelValue","onUpdate:modelValue"])])])]))),128))])]),_:1}),t(S,{label:"4楼（3项）",name:"floor4"},{default:o(()=>[s("div",Le,[(r(!0),f(w,null,T(Y(I).floor4,(l,k)=>(r(),f("div",{key:l.id,class:"inspection-item"},[s("div",qe,p(k+1),1),s("div",ze,[s("div",Ge,[d(p(l.label)+" ",1),l.type==="number"?(r(),h(M,{key:0,size:"small",type:"info"},{default:o(()=>[d(p(l.unit),1)]),_:2},1024)):x("",!0)]),s("div",Fe,[l.type==="boolean"?(r(),h(O,{key:0,modelValue:n.value.items.floor4[l.id],"onUpdate:modelValue":c=>n.value.items.floor4[l.id]=c},{default:o(()=>[t(y,{label:!0},{default:o(()=>e[19]||(e[19]=[d("正常")])),_:1,__:[19]}),t(y,{label:!1},{default:o(()=>e[20]||(e[20]=[d("异常")])),_:1,__:[20]})]),_:2},1032,["modelValue","onUpdate:modelValue"])):l.type==="number"?(r(),h(F,{key:1,modelValue:n.value.items.floor4[l.id],"onUpdate:modelValue":c=>n.value.items.floor4[l.id]=c,min:l.min,max:l.max,precision:0},null,8,["modelValue","onUpdate:modelValue","min","max"])):x("",!0),l.type==="number"?(r(),f("span",He,p(l.unit),1)):x("",!0)])])]))),128))])]),_:1})]),_:1},8,["modelValue"])]),_:1}),t(D,{class:"mt20"},{header:o(()=>e[21]||(e[21]=[s("span",null,"现场照片",-1)])),default:o(()=>[t(ue,{modelValue:n.value.photos,"onUpdate:modelValue":e[5]||(e[5]=l=>n.value.photos=l),limit:6},null,8,["modelValue"])]),_:1}),s("div",We,[t(u,{type:"primary",onClick:ee},{default:o(()=>e[22]||(e[22]=[d("保存并检查异常")])),_:1,__:[22]}),t(u,{onClick:te},{default:o(()=>e[23]||(e[23]=[d("取消")])),_:1,__:[23]})]),t(pe,{title:"检测到异常项",modelValue:C.value,"onUpdate:modelValue":e[8]||(e[8]=l=>C.value=l),width:"600px"},{footer:o(()=>[t(re,{modelValue:E.value,"onUpdate:modelValue":e[6]||(e[6]=l=>E.value=l)},{default:o(()=>e[24]||(e[24]=[d("自动生成工单")])),_:1,__:[24]},8,["modelValue"]),t(u,{onClick:e[7]||(e[7]=l=>C.value=!1)},{default:o(()=>e[25]||(e[25]=[d("跳过")])),_:1,__:[25]}),t(u,{type:"primary",onClick:le},{default:o(()=>e[26]||(e[26]=[d("确认")])),_:1,__:[26]})]),default:o(()=>[t(ie,{title:`发现 ${g.value.length} 个异常项`,type:"warning",closable:!1},null,8,["title"]),t(de,{data:g.value,class:"mt10"},{default:o(()=>[t($,{prop:"floor",label:"楼层",width:"80"}),t($,{prop:"itemName",label:"检查项"}),t($,{prop:"value",label:"异常值",width:"100"}),t($,{prop:"priority",label:"优先级",width:"80"},{default:o(l=>[t(M,{type:oe(l.row.priority)},{default:o(()=>[d(p(l.row.priority),1)]),_:2},1032,["type"])]),_:1})]),_:1},8,["data"])]),_:1},8,["modelValue"])])}}}),al=be(Qe,[["__scopeId","data-v-faec5ef4"]]);export{al as default};
