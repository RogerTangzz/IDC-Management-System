import{k as Ue,g as $e,ar as Ne,r as b,P as Pe,a7 as Ye,d as qe,ac as d,ag as ae,l as V,m as i,D as y,J as e,K as ne,u as n,C as l,Z as Me,I as H,$ as O,B as m,h as N,G as u,H as g,E as w,q as oe}from"./vue-SR65qDCS.js";import{x as Fe,y as Le,z as Be,B as ze,C as ue,D as He,E as Oe,G as Ke}from"./index-Cw83YE5u.js";import{l as Qe}from"./user-brpwFzy8.js";import"./element-D8D5Bqo2.js";import"./vendor-C71Ev03J.js";const Ge={class:"app-container"},je={key:0},Je={key:1},We={key:2},Ze={class:"dialog-footer"},Ae={class:"dialog-footer"},Xe=Ue({name:"MaintenanceExecution"}),ut=Object.assign(Xe,{setup(et){const{proxy:c}=$e(),ie=Ne(),K=b([]),P=b(!0),U=b(!0),Y=b([]),re=b(!0),Q=b(!0),q=b(0),C=b([]),k=b(!1),I=b(!1),M=b(""),s=b({}),G=b([]),{mop_category:j,execution_status:F}=c.useDict("mop_category","execution_status"),se=Pe({queryParams:{pageNum:1,pageSize:10,title:void 0,floor:void 0,executionStatus:void 0},executeForm:{executionId:void 0,planId:void 0,executorId:void 0,executionTime:void 0,executionResult:"normal",abnormalDescription:"",executionRecord:"",photos:[],attachments:[]}}),{queryParams:f,executeForm:r}=Ye(se),de={executorId:[{required:!0,message:"请选择执行人",trigger:"change"}],executionTime:[{required:!0,message:"请选择执行时间",trigger:"change"}],executionResult:[{required:!0,message:"请选择执行情况",trigger:"change"}],executionRecord:[{required:!0,message:"请输入执行记录",trigger:"blur"},{min:10,max:1e3,message:"执行记录长度在 10 到 1000 个字符",trigger:"blur"}],abnormalDescription:[{required:!0,message:"请描述异常情况",trigger:"blur"}]};function h(){P.value=!0;let o=c.addDateRange(f.value,C.value);ze(o).then(t=>{K.value=t.rows,q.value=t.total,P.value=!1})}function J(o){return{1:"1楼",2:"2楼",3:"3楼",4:"4楼",all:"全部楼层"}[o]||o}function pe(o){return!o.actualExecutionTime||!o.planExecutionTime?!1:new Date(o.actualExecutionTime)>new Date(o.planExecutionTime)}function L(){f.value.pageNum=1,h()}function me(){C.value=[],c.resetForm("queryRef"),L()}function ce(o){Y.value=o.map(t=>t.executionId),re.value=o.length!=1,Q.value=!o.length}function fe(o){ue(o.executionId).then(t=>{s.value=t.data,I.value=!0})}function _e(o){W(),r.value.planId=o.planId,r.value.executionId=o.executionId,r.value.executionTime=new Date,M.value=`执行维保计划：${o.title}`,k.value=!0}function ge(o){W(),ue(o.executionId).then(t=>{r.value=t.data,M.value=`完成维保计划：${o.title}`,k.value=!0})}function xe(){if(Y.value.length===0){c.$modal.msgWarning("请先选择要执行的计划");return}c.$modal.confirm(`确认批量执行 ${Y.value.length} 个维保计划吗？`).then(()=>{c.$modal.msgSuccess("已开始批量执行"),h()}).catch(()=>{})}function be(){c.$refs.executeRef.validate(o=>{o&&(r.value.executionId?Oe(r.value).then(t=>{c.$modal.msgSuccess("执行记录已保存"),k.value=!1,h()}):Ke(r.value).then(t=>{c.$modal.msgSuccess("已开始执行"),k.value=!1,h()}))})}function ve(o){c.$modal.confirm("确认根据异常情况生成工单吗？").then(()=>He(o.executionId)).then(()=>{c.$modal.msgSuccess("工单生成成功"),ie.push("/business/ticket")}).catch(()=>{})}function ye(){const o=c.addDateRange(f.value,C.value);c.download("business/maintenance/execution/report",o,`维保执行报告_${new Date().getTime()}.pdf`)}function we(){c.download("business/maintenance/execution/export",{...f.value},`execution_${new Date().getTime()}.xlsx`)}function ke(){window.print()}function W(){r.value={executionId:void 0,planId:void 0,executorId:void 0,executionTime:void 0,executionResult:"normal",abnormalDescription:"",executionRecord:"",photos:[],attachments:[]},c.resetForm("executeRef")}function Ve(){Qe({status:"0"}).then(o=>{G.value=o.rows})}return qe(()=>{h(),Ve()}),(o,t)=>{const B=d("el-input"),v=d("el-form-item"),R=d("el-option"),z=d("el-select"),Z=d("el-date-picker"),x=d("el-button"),A=d("el-form"),S=d("el-col"),he=d("right-toolbar"),X=d("el-row"),p=d("el-table-column"),D=d("el-tag"),$=d("dict-tag"),ee=d("el-table"),Re=d("pagination"),te=d("el-radio"),Ce=d("el-radio-group"),le=d("el-dialog"),_=d("el-descriptions-item"),De=d("el-alert"),Te=d("el-link"),Ie=d("el-descriptions"),Se=d("el-divider"),T=ae("hasPermi"),Ee=ae("loading");return i(),V("div",Ge,[y(e(A,{model:n(f),ref:"queryRef",inline:!0,"label-width":"68px"},{default:l(()=>[e(v,{label:"计划标题",prop:"title"},{default:l(()=>[e(B,{modelValue:n(f).title,"onUpdate:modelValue":t[0]||(t[0]=a=>n(f).title=a),placeholder:"请输入计划标题",clearable:"",onKeyup:Me(L,["enter"])},null,8,["modelValue"])]),_:1}),e(v,{label:"楼层",prop:"floor"},{default:l(()=>[e(z,{modelValue:n(f).floor,"onUpdate:modelValue":t[1]||(t[1]=a=>n(f).floor=a),placeholder:"请选择楼层",clearable:""},{default:l(()=>[e(R,{label:"1楼",value:"1"}),e(R,{label:"2楼",value:"2"}),e(R,{label:"3楼",value:"3"}),e(R,{label:"4楼",value:"4"}),e(R,{label:"全部楼层",value:"all"})]),_:1},8,["modelValue"])]),_:1}),e(v,{label:"执行状态",prop:"executionStatus"},{default:l(()=>[e(z,{modelValue:n(f).executionStatus,"onUpdate:modelValue":t[2]||(t[2]=a=>n(f).executionStatus=a),placeholder:"请选择状态",clearable:""},{default:l(()=>[(i(!0),V(H,null,O(n(F),a=>(i(),m(R,{key:a.value,label:a.label,value:a.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),e(v,{label:"执行时间"},{default:l(()=>[e(Z,{modelValue:n(C),"onUpdate:modelValue":t[3]||(t[3]=a=>N(C)?C.value=a:null),"value-format":"YYYY-MM-DD",type:"daterange","range-separator":"至","start-placeholder":"开始日期","end-placeholder":"结束日期"},null,8,["modelValue"])]),_:1}),e(v,null,{default:l(()=>[e(x,{type:"primary",icon:"Search",onClick:L},{default:l(()=>t[18]||(t[18]=[u("搜索")])),_:1,__:[18]}),e(x,{icon:"Refresh",onClick:me},{default:l(()=>t[19]||(t[19]=[u("重置")])),_:1,__:[19]})]),_:1})]),_:1},8,["model"]),[[ne,n(U)]]),e(X,{gutter:10,class:"mb8"},{default:l(()=>[e(S,{span:1.5},{default:l(()=>[y((i(),m(x,{type:"primary",plain:"",icon:"VideoPlay",disabled:n(Q),onClick:xe},{default:l(()=>t[20]||(t[20]=[u("批量执行")])),_:1,__:[20]},8,["disabled"])),[[T,["business:maintenance:execute"]]])]),_:1}),e(S,{span:1.5},{default:l(()=>[y((i(),m(x,{type:"warning",plain:"",icon:"Download",onClick:we},{default:l(()=>t[21]||(t[21]=[u("导出")])),_:1,__:[21]})),[[T,["business:maintenance:export"]]])]),_:1}),e(S,{span:1.5},{default:l(()=>[e(x,{type:"info",plain:"",icon:"Document",onClick:ye},{default:l(()=>t[22]||(t[22]=[u("生成报告")])),_:1,__:[22]})]),_:1}),e(he,{showSearch:n(U),"onUpdate:showSearch":t[4]||(t[4]=a=>N(U)?U.value=a:null),onQueryTable:h},null,8,["showSearch"])]),_:1}),y((i(),m(ee,{data:n(K),onSelectionChange:ce},{default:l(()=>[e(p,{type:"selection",width:"55",align:"center"}),e(p,{label:"执行编号",align:"center",prop:"executionNo",width:"120"}),e(p,{label:"计划标题",align:"left",prop:"title","show-overflow-tooltip":!0}),e(p,{label:"楼层",align:"center",prop:"floor",width:"80"},{default:l(a=>[e(D,null,{default:l(()=>[u(g(J(a.row.floor)),1)]),_:2},1024)]),_:1}),e(p,{label:"版本",align:"center",prop:"version",width:"80"}),e(p,{label:"MOP类别",align:"center",prop:"mopCategory",width:"100"},{default:l(a=>[e($,{options:n(j),value:a.row.mopCategory},null,8,["options","value"])]),_:1}),e(p,{label:"执行人",align:"center",prop:"executorName",width:"100"}),e(p,{label:"计划时间",align:"center",prop:"planExecutionTime",width:"160"},{default:l(a=>[u(g(o.parseTime(a.row.planExecutionTime)),1)]),_:1}),e(p,{label:"实际执行时间",align:"center",prop:"actualExecutionTime",width:"160"},{default:l(a=>[a.row.actualExecutionTime?(i(),V("span",je,[u(g(o.parseTime(a.row.actualExecutionTime))+" ",1),pe(a.row)?(i(),m(D,{key:0,type:"warning",size:"small"},{default:l(()=>t[23]||(t[23]=[u("延期")])),_:1,__:[23]})):w("",!0)])):(i(),V("span",Je,"-"))]),_:1}),e(p,{label:"执行状态",align:"center",prop:"executionStatus",width:"100"},{default:l(a=>[e($,{options:n(F),value:a.row.executionStatus},null,8,["options","value"])]),_:1}),e(p,{label:"执行结果",align:"center",prop:"executionResult",width:"100"},{default:l(a=>[a.row.executionResult==="normal"?(i(),m(D,{key:0,type:"success"},{default:l(()=>t[24]||(t[24]=[u("正常")])),_:1,__:[24]})):a.row.executionResult==="abnormal"?(i(),m(D,{key:1,type:"danger"},{default:l(()=>t[25]||(t[25]=[u("异常")])),_:1,__:[25]})):(i(),V("span",We,"-"))]),_:1}),e(p,{label:"操作",align:"center","class-name":"small-padding fixed-width",width:"220"},{default:l(a=>[y((i(),m(x,{link:"",type:"primary",icon:"View",onClick:E=>fe(a.row)},{default:l(()=>t[26]||(t[26]=[u("查看")])),_:2,__:[26]},1032,["onClick"])),[[T,["business:maintenance:query"]]]),a.row.executionStatus==="pending"?y((i(),m(x,{key:0,link:"",type:"success",icon:"VideoPlay",onClick:E=>_e(a.row)},{default:l(()=>t[27]||(t[27]=[u("执行")])),_:2,__:[27]},1032,["onClick"])),[[T,["business:maintenance:execute"]]]):w("",!0),a.row.executionStatus==="executing"?y((i(),m(x,{key:1,link:"",type:"warning",icon:"Check",onClick:E=>ge(a.row)},{default:l(()=>t[28]||(t[28]=[u("完成")])),_:2,__:[28]},1032,["onClick"])),[[T,["business:maintenance:execute"]]]):w("",!0),a.row.executionResult==="abnormal"?y((i(),m(x,{key:2,link:"",type:"danger",icon:"Tickets",onClick:E=>ve(a.row)},{default:l(()=>t[29]||(t[29]=[u("生成工单")])),_:2,__:[29]},1032,["onClick"])),[[T,["business:ticket:add"]]]):w("",!0)]),_:1})]),_:1},8,["data"])),[[Ee,n(P)]]),y(e(Re,{total:n(q),page:n(f).pageNum,"onUpdate:page":t[5]||(t[5]=a=>n(f).pageNum=a),limit:n(f).pageSize,"onUpdate:limit":t[6]||(t[6]=a=>n(f).pageSize=a),onPagination:h},null,8,["total","page","limit"]),[[ne,n(q)>0]]),e(le,{title:n(M),modelValue:n(k),"onUpdate:modelValue":t[15]||(t[15]=a=>N(k)?k.value=a:null),width:"700px","append-to-body":""},{footer:l(()=>[oe("div",Ze,[e(x,{type:"primary",onClick:be},{default:l(()=>t[32]||(t[32]=[u("确 定")])),_:1,__:[32]}),e(x,{onClick:t[14]||(t[14]=a=>k.value=!1)},{default:l(()=>t[33]||(t[33]=[u("取 消")])),_:1,__:[33]})])]),default:l(()=>[e(A,{ref:"executeRef",model:n(r),rules:de,"label-width":"100px"},{default:l(()=>[e(X,null,{default:l(()=>[e(S,{span:12},{default:l(()=>[e(v,{label:"执行人",prop:"executorId"},{default:l(()=>[e(z,{modelValue:n(r).executorId,"onUpdate:modelValue":t[7]||(t[7]=a=>n(r).executorId=a),placeholder:"请选择执行人"},{default:l(()=>[(i(!0),V(H,null,O(n(G),a=>(i(),m(R,{key:a.userId,label:a.nickName,value:a.userId},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})]),_:1}),e(S,{span:12},{default:l(()=>[e(v,{label:"执行时间",prop:"executionTime"},{default:l(()=>[e(Z,{modelValue:n(r).executionTime,"onUpdate:modelValue":t[8]||(t[8]=a=>n(r).executionTime=a),type:"datetime",placeholder:"选择执行时间",format:"YYYY-MM-DD HH:mm:ss","value-format":"YYYY-MM-DD HH:mm:ss"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),e(v,{label:"执行情况",prop:"executionResult"},{default:l(()=>[e(Ce,{modelValue:n(r).executionResult,"onUpdate:modelValue":t[9]||(t[9]=a=>n(r).executionResult=a)},{default:l(()=>[e(te,{label:"normal"},{default:l(()=>t[30]||(t[30]=[u("正常")])),_:1,__:[30]}),e(te,{label:"abnormal"},{default:l(()=>t[31]||(t[31]=[u("异常")])),_:1,__:[31]})]),_:1},8,["modelValue"])]),_:1}),n(r).executionResult==="abnormal"?(i(),m(v,{key:0,label:"异常描述",prop:"abnormalDescription"},{default:l(()=>[e(B,{modelValue:n(r).abnormalDescription,"onUpdate:modelValue":t[10]||(t[10]=a=>n(r).abnormalDescription=a),type:"textarea",rows:3,placeholder:"请描述异常情况",maxlength:"500","show-word-limit":""},null,8,["modelValue"])]),_:1})):w("",!0),e(v,{label:"执行记录",prop:"executionRecord"},{default:l(()=>[e(B,{modelValue:n(r).executionRecord,"onUpdate:modelValue":t[11]||(t[11]=a=>n(r).executionRecord=a),type:"textarea",rows:4,placeholder:"请输入执行记录",maxlength:"1000","show-word-limit":""},null,8,["modelValue"])]),_:1}),e(v,{label:"现场照片"},{default:l(()=>[e(n(Fe),{modelValue:n(r).photos,"onUpdate:modelValue":t[12]||(t[12]=a=>n(r).photos=a),limit:6},null,8,["modelValue"])]),_:1}),e(v,{label:"附件"},{default:l(()=>[e(n(Le),{modelValue:n(r).attachments,"onUpdate:modelValue":t[13]||(t[13]=a=>n(r).attachments=a),limit:3},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["title","modelValue"]),e(le,{title:"执行记录详情",modelValue:n(I),"onUpdate:modelValue":t[17]||(t[17]=a=>N(I)?I.value=a:null),width:"800px","append-to-body":""},{footer:l(()=>[oe("div",Ae,[e(x,{onClick:t[16]||(t[16]=a=>I.value=!1)},{default:l(()=>t[35]||(t[35]=[u("关 闭")])),_:1,__:[35]}),e(x,{type:"primary",onClick:ke},{default:l(()=>t[36]||(t[36]=[u("打 印")])),_:1,__:[36]})])]),default:l(()=>[e(Ie,{column:2,border:""},{default:l(()=>[e(_,{label:"执行编号"},{default:l(()=>[u(g(n(s).executionNo),1)]),_:1}),e(_,{label:"计划标题"},{default:l(()=>[u(g(n(s).title),1)]),_:1}),e(_,{label:"楼层"},{default:l(()=>[u(g(J(n(s).floor)),1)]),_:1}),e(_,{label:"版本"},{default:l(()=>[u(g(n(s).version),1)]),_:1}),e(_,{label:"MOP类别"},{default:l(()=>[e($,{options:n(j),value:n(s).mopCategory},null,8,["options","value"])]),_:1}),e(_,{label:"执行人"},{default:l(()=>[u(g(n(s).executorName),1)]),_:1}),e(_,{label:"计划时间"},{default:l(()=>[u(g(o.parseTime(n(s).planExecutionTime)),1)]),_:1}),e(_,{label:"实际执行时间"},{default:l(()=>[u(g(o.parseTime(n(s).actualExecutionTime)||"未执行"),1)]),_:1}),e(_,{label:"执行状态"},{default:l(()=>[e($,{options:n(F),value:n(s).executionStatus},null,8,["options","value"])]),_:1}),e(_,{label:"执行结果"},{default:l(()=>[e(D,{type:n(s).executionResult==="normal"?"success":"danger"},{default:l(()=>[u(g(n(s).executionResult==="normal"?"正常":"异常"),1)]),_:1},8,["type"])]),_:1}),e(_,{label:"执行记录",span:2},{default:l(()=>[u(g(n(s).executionRecord),1)]),_:1}),n(s).abnormalDescription?(i(),m(_,{key:0,label:"异常描述",span:2},{default:l(()=>[e(De,{title:n(s).abnormalDescription,type:"warning",closable:!1},null,8,["title"])]),_:1})):w("",!0),n(s).photos&&n(s).photos.length>0?(i(),m(_,{key:1,label:"现场照片",span:2},{default:l(()=>[e(n(Be),{"src-list":n(s).photos},null,8,["src-list"])]),_:1})):w("",!0),n(s).attachments&&n(s).attachments.length>0?(i(),m(_,{key:2,label:"附件",span:2},{default:l(()=>[(i(!0),V(H,null,O(n(s).attachments,(a,E)=>(i(),V("div",{key:E},[e(Te,{type:"primary",href:a.url,target:"_blank"},{default:l(()=>[u(g(a.name),1)]),_:2},1032,["href"])]))),128))]),_:1})):w("",!0)]),_:1}),e(Se,{"content-position":"left"},{default:l(()=>t[34]||(t[34]=[u("执行步骤检查")])),_:1,__:[34]}),n(s).checkList?(i(),m(ee,{key:0,data:n(s).checkList},{default:l(()=>[e(p,{label:"序号",type:"index",width:"60",align:"center"}),e(p,{label:"检查项",prop:"item"}),e(p,{label:"标准",prop:"standard"}),e(p,{label:"结果",prop:"result",width:"100",align:"center"},{default:l(a=>[e(D,{type:a.row.result==="pass"?"success":"danger"},{default:l(()=>[u(g(a.row.result==="pass"?"合格":"不合格"),1)]),_:2},1032,["type"])]),_:1}),e(p,{label:"备注",prop:"remark"})]),_:1},8,["data"])):w("",!0)]),_:1},8,["modelValue"])])}}});export{ut as default};
